(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(i){if(i.ep)return;i.ep=!0;const l=s(i);fetch(i.href,l)}})();const m=40,_=20,w=15;let S=[],B=[];function b(a,e,s=1){const t=[];if(s>0)for(let i=a;i<=e;i+=s)t.push(i);else for(let i=a;i>=e;i+=s)t.push(i);return t}function ie(a){return a.map(([e,s])=>({x:s*m+m/2,y:e*m+m/2}))}const se=[...b(0,8).map(a=>[2,a]),...b(3,6).map(a=>[a,8]),...b(7,2,-1).map(a=>[6,a]),...b(7,9).map(a=>[a,2]),...b(3,17).map(a=>[9,a]),...b(10,12).map(a=>[a,17]),...b(16,10,-1).map(a=>[12,a]),[13,10],[14,10]],ae=[...b(0,4).map(a=>[7,a]),...b(6,3,-1).map(a=>[a,4]),...b(5,17).map(a=>[3,a]),...b(4,7).map(a=>[a,17]),[7,18],[7,19]],le=[...b(0,4).map(a=>[7,a]),...b(8,11).map(a=>[a,4]),...b(5,17).map(a=>[11,a]),...b(10,7,-1).map(a=>[a,17]),[7,18],[7,19]],oe=[...b(0,3).map(a=>[a,3]),...b(4,10).map(a=>[3,a]),...b(4,7).map(a=>[a,10])],ne=[...b(0,4).map(a=>[12,a]),...b(5,10).map(a=>[12,a]),...b(11,8,-1).map(a=>[a,10]),[7,10]],he=[...b(19,15,-1).map(a=>[2,a]),...b(3,7).map(a=>[a,15]),...b(14,10,-1).map(a=>[7,a])];function P(a,e,s){return e+Math.floor(a()*(s-e+1))}function re(a,e,s){const t=[];let i=e,l=0;const o=P(a,3,5),n=[];for(let h=0;h<o;h++){const r=Math.floor((_-2)/(o+1))*(h+1);n.push(Math.max(2,Math.min(_-3,r+P(a,-1,1))))}for(let h=0;h<o;h++){const r=n[h],d=r>l?1:-1;for(;l!==r;)t.push([i,l]),l+=d;t.push([i,l]);let u;if(h===o-1)u=s;else{let p=0;do u=P(a,1,w-2),p++;while(p<20&&Math.abs(u-i)<3)}const f=u>i?1:-1;for(;i!==u;)i+=f,t.push([i,l])}for(;l<_-1;)l++,t.push([i,l]);return t}function de(){const a=()=>Math.random();if(P(a,1,2)===1){const s=P(a,2,w-3),t=P(a,2,w-3),i=re(a,s,t);return{pathCellArrays:[i],starts:[[i[0][0],i[0][1]]],ends:[[i[i.length-1][0],i[i.length-1][1]]]}}else{const s=P(a,5,w-6),t=P(a,3,6),i=[];for(let c=0;c<=t;c++)i.push([s,c]);const l=P(a,1,Math.max(2,s-3)),o=P(a,1,Math.max(2,s-2)),n=P(a,Math.min(w-3,s+3),w-2),h=P(a,Math.min(w-3,s+2),w-2),r=t,d=[...i];for(let c=s-1;c>=l;c--)d.push([c,r]);const u=j(a,l,r+1,o,1,Math.max(1,s-1));d.push(...u);const f=[...i];for(let c=s+1;c<=n;c++)f.push([c,r]);const p=j(a,n,r+1,h,Math.min(w-2,s+1),w-2);return f.push(...p),{pathCellArrays:[d,f],starts:[[s,0]],ends:[[d[d.length-1][0],d[d.length-1][1]],[f[f.length-1][0],f[f.length-1][1]]]}}}function j(a,e,s,t,i,l){const o=[];let n=e,h=s;const r=P(a,2,3),d=_-1-s,u=[];for(let f=0;f<r;f++){const p=s+Math.floor(d/(r+1))*(f+1);u.push(Math.max(s+1,Math.min(_-3,p+P(a,-1,1))))}for(let f=0;f<r;f++){const p=u[f];for(;h<p;)o.push([n,h]),h++;o.push([n,h]);let c;if(f===r-1)c=t;else{let y=0;do c=P(a,i,l),y++;while(y<20&&Math.abs(c-n)<2)}const g=c>n?1:-1;for(;n!==c;)n+=g,o.push([n,h])}for(;h<_-1;)h++,o.push([n,h]);return o}const N=[{id:1,name:"Луг",difficulty:"Лёгкий",desc:"Один длинный извилистый путь. Классический уровень для начала.",color:"#2ecc71",startGold:300,startLives:20,pathCellArrays:[se],starts:[[2,0]],ends:[[14,10]]},{id:2,name:"Развилка",difficulty:"Средний",desc:"Путь раздваивается! Враги случайно выбирают верхний или нижний маршрут.",color:"#e3b341",startGold:350,startLives:15,pathCellArrays:[ae,le],starts:[[7,0]],ends:[[7,19]]},{id:3,name:"Осада",difficulty:"Сложный",desc:"База в центре карты. Враги атакуют с трёх сторон!",color:"#f85149",startGold:450,startLives:10,pathCellArrays:[oe,ne,he],starts:[[0,3],[12,0],[2,19]],ends:[[7,10]]},{id:4,name:"Хаос",difficulty:"Случайный",desc:"Каждая игра — новая карта! Путь генерируется случайно.",color:"#a855f7",startGold:350,startLives:15,pathCellArrays:null,starts:null,ends:null,randomGen:!0}];function pe(a){let e=N.find(s=>s.id===a);if(e){if(e.randomGen){const s=de();e={...e,...s}}S=[];for(let s=0;s<w;s++)S[s]=new Array(_).fill(0);for(const s of e.pathCellArrays)for(const[t,i]of s)t>=0&&t<w&&i>=0&&i<_&&(S[t][i]=1);for(const[s,t]of e.starts)s>=0&&s<w&&t>=0&&t<_&&(S[s][t]=2);for(const[s,t]of e.ends)s>=0&&s<w&&t>=0&&t<_&&(S[s][t]=3);B=e.pathCellArrays.map(s=>ie(s))}}function z(a,e){return a<0||a>=w||e<0||e>=_?!1:S[a][e]===0}function V(a,e){return{col:Math.floor(a/m),row:Math.floor(e/m)}}class fe{constructor(){this.ctx=null,this.masterGain=null,this.volume=.3}setVolume(e){this.volume=e,this.masterGain&&(this.masterGain.gain.value=e)}_ensureContext(){if(this.ctx)return!0;try{return this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=this.volume,this.masterGain.connect(this.ctx.destination),!0}catch{return!1}}_now(){return this.ctx.currentTime}_gain(e){const s=this.ctx.createGain();return s.gain.value=e,s.connect(this.masterGain),s}_osc(e,s,t,i,l){const o=this.ctx.createOscillator();return o.type=e,o.frequency.value=s,o.connect(t),o.start(i),o.stop(l),o}_noiseBuffer(e){const s=this.ctx.sampleRate,t=s*e,i=this.ctx.createBuffer(1,t,s),l=i.getChannelData(0);for(let o=0;o<t;o++)l[o]=Math.random()*2-1;return i}_playNoise(e,s,t){const i=this.ctx.createBufferSource();return i.buffer=this._noiseBuffer(e+.05),i.connect(s),i.start(t),i.stop(t+e),i}gunShoot(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.12),t=this.ctx.createBiquadFilter();t.type="highpass",t.frequency.value=2e3,t.connect(s);const i=this.ctx.createGain();i.gain.setValueAtTime(1,e),i.gain.exponentialRampToValueAtTime(.01,e+.05),i.connect(t),this._playNoise(.05,i,e)}cannonShoot(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.2),t=this.ctx.createGain();t.gain.setValueAtTime(.8,e),t.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(s),this._osc("sine",80,t,e,e+.2).frequency.exponentialRampToValueAtTime(40,e+.2);const l=this.ctx.createGain();l.gain.setValueAtTime(.3,e),l.gain.exponentialRampToValueAtTime(.01,e+.15),l.connect(s);const o=this.ctx.createBiquadFilter();o.type="lowpass",o.frequency.value=400,o.connect(l),this._playNoise(.15,o,e)}sniperShoot(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createGain();t.gain.setValueAtTime(1,e),t.gain.exponentialRampToValueAtTime(.01,e+.08),t.connect(s),this._osc("sine",1500,t,e,e+.08).frequency.exponentialRampToValueAtTime(200,e+.08)}teslaShoot(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createGain();t.gain.setValueAtTime(.6,e),t.gain.exponentialRampToValueAtTime(.01,e+.12),t.connect(s);const i=this._osc("sawtooth",800,t,e,e+.12),l=this._osc("sine",40,i.frequency,e,e+.12);l.frequency.value=40;const o=this.ctx.createGain();o.gain.value=300,l.disconnect(),l.connect(o),o.connect(i.frequency);const n=this.ctx.createGain();n.gain.setValueAtTime(.3,e),n.gain.exponentialRampToValueAtTime(.01,e+.1),n.connect(s),this._playNoise(.1,n,e)}splashHit(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.18),t=this.ctx.createGain();t.gain.setValueAtTime(.7,e),t.gain.exponentialRampToValueAtTime(.01,e+.12),t.connect(s),this._osc("sine",60,t,e,e+.12).frequency.exponentialRampToValueAtTime(30,e+.12);const l=this.ctx.createGain();l.gain.setValueAtTime(.4,e),l.gain.exponentialRampToValueAtTime(.01,e+.1),l.connect(s),this._playNoise(.1,l,e)}beamFire(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createGain();t.gain.setValueAtTime(.8,e),t.gain.exponentialRampToValueAtTime(.01,e+.15),t.connect(s),this._osc("sine",3e3,t,e,e+.15).frequency.exponentialRampToValueAtTime(500,e+.15)}shieldActivate(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.12),t=this.ctx.createGain();t.gain.setValueAtTime(.01,e),t.gain.linearRampToValueAtTime(.6,e+.05),t.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(s),this._osc("sine",400,t,e,e+.2).frequency.exponentialRampToValueAtTime(1200,e+.15)}healPulse(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.1);for(const t of[800,1200]){const i=this.ctx.createGain();i.gain.setValueAtTime(.5,e),i.gain.exponentialRampToValueAtTime(.01,e+.3),i.connect(s),this._osc("sine",t,i,e,e+.3)}}teleport(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createBiquadFilter();t.type="bandpass",t.frequency.setValueAtTime(200,e),t.frequency.exponentialRampToValueAtTime(4e3,e+.15),t.Q.value=2,t.connect(s);const i=this.ctx.createGain();i.gain.setValueAtTime(.8,e),i.gain.exponentialRampToValueAtTime(.01,e+.15),i.connect(t),this._playNoise(.15,i,e)}phaseToggle(e=!0){if(!this._ensureContext())return;const s=this._now(),t=this._gain(.08),i=this.ctx.createGain();i.gain.setValueAtTime(.5,s),i.gain.exponentialRampToValueAtTime(.01,s+.1),i.connect(t);const l=e?600:1800,o=e?1800:600;this._osc("sine",l,i,s,s+.1).frequency.exponentialRampToValueAtTime(o,s+.1)}enrage(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createWaveShaper(),i=new Float32Array(256);for(let o=0;o<256;o++){const n=o/128-1;i[o]=(Math.PI+4)*n/(Math.PI+4*Math.abs(n))}t.curve=i,t.connect(s);const l=this.ctx.createGain();l.gain.setValueAtTime(.8,e),l.gain.exponentialRampToValueAtTime(.01,e+.2),l.connect(t),this._osc("sawtooth",100,l,e,e+.2)}massShield(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createGain();t.gain.setValueAtTime(.01,e),t.gain.linearRampToValueAtTime(.7,e+.1),t.gain.exponentialRampToValueAtTime(.01,e+.4),t.connect(s),this._osc("sine",300,t,e,e+.4).frequency.exponentialRampToValueAtTime(1500,e+.3);const l=this.ctx.createGain();l.gain.setValueAtTime(.01,e+.05),l.gain.linearRampToValueAtTime(.5,e+.15),l.gain.exponentialRampToValueAtTime(.01,e+.4),l.connect(s),this._osc("sine",500,l,e+.05,e+.4).frequency.exponentialRampToValueAtTime(2e3,e+.35)}towerDisable(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.2),t=this.ctx.createGain();t.gain.setValueAtTime(.8,e),t.gain.exponentialRampToValueAtTime(.01,e+.3),t.connect(s),this._osc("sine",50,t,e,e+.3);const i=this.ctx.createGain();i.gain.setValueAtTime(.6,e),i.gain.exponentialRampToValueAtTime(.01,e+.15),i.connect(s),this._playNoise(.15,i,e)}queenSpawn(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.1),t=this.ctx.createBiquadFilter();t.type="lowpass",t.frequency.value=500,t.connect(s);const i=this.ctx.createGain();i.gain.setValueAtTime(.7,e),i.gain.exponentialRampToValueAtTime(.01,e+.08),i.connect(t),this._playNoise(.08,i,e)}towerPlace(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createGain();t.gain.setValueAtTime(.6,e),t.gain.exponentialRampToValueAtTime(.01,e+.03),t.connect(s),this._osc("sine",400,t,e,e+.03);const i=this.ctx.createGain();i.gain.setValueAtTime(.4,e+.03),i.gain.exponentialRampToValueAtTime(.01,e+.05),i.connect(s),this._osc("sine",600,i,e+.03,e+.06)}towerSell(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.12);[1e3,1500,2e3].forEach((i,l)=>{const o=l*.04,n=this.ctx.createGain();n.gain.setValueAtTime(.5,e+o),n.gain.exponentialRampToValueAtTime(.01,e+o+.06),n.connect(s),this._osc("sine",i,n,e+o,e+o+.06)})}towerMerge(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.18),t=this.ctx.createGain();t.gain.setValueAtTime(.01,e),t.gain.linearRampToValueAtTime(.8,e+.1),t.gain.exponentialRampToValueAtTime(.01,e+.35),t.connect(s),this._osc("sine",200,t,e,e+.35).frequency.exponentialRampToValueAtTime(2e3,e+.25);const l=this.ctx.createGain();l.gain.setValueAtTime(.01,e+.1),l.gain.linearRampToValueAtTime(.4,e+.2),l.gain.exponentialRampToValueAtTime(.01,e+.4),l.connect(s),this._osc("sine",1200,l,e+.1,e+.4)}enemyDeath(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.08),t=this.ctx.createGain();t.gain.setValueAtTime(.5,e),t.gain.exponentialRampToValueAtTime(.01,e+.08),t.connect(s),this._osc("sine",300,t,e,e+.08).frequency.exponentialRampToValueAtTime(100,e+.08)}lifeLost(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.25);for(let t=0;t<2;t++){const i=e+t*.18,l=this.ctx.createGain();l.gain.setValueAtTime(.7,i),l.gain.exponentialRampToValueAtTime(.01,i+.15),l.connect(s),this._osc("sine",500,l,i,i+.15).frequency.exponentialRampToValueAtTime(200,i+.15)}}gameOver(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.3);[400,300,200].forEach((i,l)=>{const o=e+l*.25,n=this.ctx.createGain();n.gain.setValueAtTime(.7,o),n.gain.exponentialRampToValueAtTime(.01,o+.22),n.connect(s),this._osc("sine",i,n,o,o+.22)})}waveStart(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.15),t=this.ctx.createGain();t.gain.setValueAtTime(.01,e),t.gain.linearRampToValueAtTime(.6,e+.15),t.gain.setValueAtTime(.6,e+.25),t.gain.exponentialRampToValueAtTime(.01,e+.4),t.connect(s),this._osc("sine",500,t,e,e+.4);const i=this.ctx.createGain();i.gain.setValueAtTime(.01,e),i.gain.linearRampToValueAtTime(.3,e+.15),i.gain.setValueAtTime(.3,e+.25),i.gain.exponentialRampToValueAtTime(.01,e+.4),i.connect(s),this._osc("sine",750,i,e,e+.4)}cardSelect(){if(!this._ensureContext())return;const e=this._now(),s=this._gain(.1),t=this.ctx.createGain();t.gain.setValueAtTime(.5,e),t.gain.exponentialRampToValueAtTime(.01,e+.04),t.connect(s),this._osc("sine",1e3,t,e,e+.04)}eventWave(e){if(!this._ensureContext())return;const s=this._now();if(e==="rare"){const t=this._gain(.12),i=this.ctx.createGain();i.gain.setValueAtTime(.6,s),i.gain.exponentialRampToValueAtTime(.01,s+.5),i.connect(t),this._osc("sine",1200,i,s,s+.5)}else if(e==="epic"){const t=this._gain(.15);for(const i of[600,900,1200]){const l=this.ctx.createGain();l.gain.setValueAtTime(.5,s),l.gain.exponentialRampToValueAtTime(.01,s+.6),l.connect(t),this._osc("sine",i,l,s,s+.6)}}else if(e==="legendary"){const t=this._gain(.2);for(const o of[400,600,800,1e3,1200]){const n=this.ctx.createGain();n.gain.setValueAtTime(.01,s),n.gain.linearRampToValueAtTime(.5,s+.15),n.gain.exponentialRampToValueAtTime(.01,s+1),n.connect(t),this._osc("sine",o,n,s,s+1)}const i=this.ctx.createGain();i.gain.setValueAtTime(.01,s),i.gain.linearRampToValueAtTime(.2,s+.2),i.gain.exponentialRampToValueAtTime(.01,s+.8),i.connect(t);const l=this.ctx.createBiquadFilter();l.type="bandpass",l.frequency.value=2e3,l.Q.value=3,l.connect(i),this._playNoise(.8,l,s)}}}const M=new fe,L={gun:{name:"Пулемёт",cost:100,damage:8,range:3,fireRate:.15,color:"#2ecc71",shape:"circle",projectileSpeed:8,projectileColor:"#2ecc71",description:"Быстрая стрельба, одна цель",special:null},cannon:{name:"Пушка",cost:200,damage:30,range:3.5,fireRate:1.2,color:"#e67e22",shape:"square",projectileSpeed:5,projectileColor:"#e67e22",description:"Урон по площади",special:"splash",splashRadius:60},sniper:{name:"Снайпер",cost:300,damage:60,range:6,fireRate:2,color:"#3498db",shape:"triangle",projectileSpeed:14,projectileColor:"#3498db",description:"Дальний, мощный",special:null},tesla:{name:"Тесла",cost:400,damage:20,range:3.5,fireRate:1,color:"#a855f7",shape:"hexagon",projectileSpeed:0,projectileColor:"#a855f7",description:"Молния по цепи (3 цели)",special:"chain",chainCount:3,chainRange:80}},ue=["gun","cannon","sniper","tesla"],ce={1:{dmg:1,fireRate:1,range:1},2:{dmg:1.1,fireRate:.95,range:1.05},3:{dmg:1.25,fireRate:.9,range:1.1},4:{dmg:1.5,fireRate:.85,range:1.15}};function ge(a,e,s,t,i,l){const o=Math.cos(s),n=Math.sin(s),h=t-a,r=i-e;return h*o+r*n<0?!1:Math.abs(h*n-r*o)<=l}class me{constructor(e,s,t){const i=L[e];this.type=e,this.name=i.name,this.color=i.color,this.shape=i.shape,this.projectileSpeed=i.projectileSpeed,this.projectileColor=i.projectileColor,this.special=i.special,this.cost=i.cost,this.baseDamage=i.damage,this.baseFireRate=i.fireRate,this.baseRange=i.range*m,this.damage=this.baseDamage,this.fireRate=this.baseFireRate,this.range=this.baseRange,this.splashRadius=i.splashRadius||0,this.slowFactor=i.slowFactor||1,this.slowDuration=i.slowDuration||0,this.chainCount=i.chainCount||0,this.chainRange=i.chainRange||0,this.row=s,this.col=t,this.x=t*m+m/2,this.y=s*m+m/2,this.cooldown=0,this.target=null,this.angle=0,this.level=1,this.disabledTimer=0}applyLevel(e){this.level=e;const s=ce[e];this.damage=this.baseDamage*s.dmg,this.range=this.baseRange*s.range,this.fireRate=this.baseFireRate*s.fireRate,e===4&&this.type==="tesla"&&(this.chainCount=6)}update(e,s,t,i,l=null){if(this.disabledTimer>0){this.disabledTimer-=e;return}this.cooldown-=e,this.target=null;let o=-1;const n=l?l.towerRangeMult:1,h=this.range*n;let r=1;for(const d of s){if(!d.alive||d.special!=="tower_slow")continue;const u=d.x-this.x,f=d.y-this.y;Math.sqrt(u*u+f*f)<=d.slowAuraRadius&&(r=Math.min(r,d.towerSlowFactor))}for(const d of s){if(!d.targetable)continue;const u=d.x-this.x,f=d.y-this.y;Math.sqrt(u*u+f*f)<=h&&d.progress>o&&(o=d.progress,this.target=d)}if(this.target){this.angle=Math.atan2(this.target.y-this.y,this.target.x-this.x);const d=(l?l.towerFireRateMult:1)/r;this.cooldown<=0&&(this.cooldown=this.fireRate*d,this.shoot(this.target,s,t,i,l))}}shoot(e,s,t,i,l=null){const o=l?l.towerDamageMult:1,n=this.damage*o;if(this.special==="chain"){const h=[e];e.takeDamage(n),this.level===4&&e.applySlow(.7,1.5);let r=e;for(let d=1;d<this.chainCount;d++){let u=null,f=this.chainRange;for(const p of s){if(!p.alive||h.includes(p))continue;const c=p.x-r.x,g=p.y-r.y,y=Math.sqrt(c*c+g*g);y<f&&(f=y,u=p)}if(u)h.push(u),u.takeDamage(n),this.level===4&&u.applySlow(.7,1.5),r=u;else break}t({type:"chain",points:h.map(d=>({x:d.x,y:d.y})),startX:this.x,startY:this.y,color:this.projectileColor,timer:.3,particles:i}),i&&i.emitMuzzle(this.x,this.y,this.angle,this.projectileColor),M.teslaShoot()}else if(this.type==="sniper"&&this.level===4){for(const h of s)!h.alive||!h.targetable||ge(this.x,this.y,this.angle,h.x,h.y,h.radius+8)&&(h.takeDamage(n),i&&i.emitImpact(h.x,h.y,this.projectileColor));t({type:"beam",x:this.x,y:this.y,angle:this.angle,length:this.range,color:this.projectileColor,timer:.15,particles:i}),i&&i.emitMuzzle(this.x,this.y,this.angle,this.projectileColor),M.beamFire()}else{if(t({type:"bullet",x:this.x,y:this.y,targetId:e,speed:this.projectileSpeed*60,damage:n,color:this.projectileColor,tower:this,particles:i}),i&&i.emitMuzzle(this.x,this.y,this.angle,this.projectileColor),this.type==="gun"?M.gunShoot():this.type==="cannon"?M.cannonShoot():this.type==="sniper"&&M.sniperShoot(),this.type==="gun"&&this.level===4)for(let h=0;h<2;h++)t({type:"bullet",x:this.x,y:this.y,targetId:e,speed:this.projectileSpeed*60,damage:Math.round(n*.35),color:this.projectileColor,tower:this,particles:i});this.type==="cannon"&&this.level===4&&t({type:"burnzone",x:e.x,y:e.y,duration:2,tickDamage:Math.round(this.damage*.15*o),radius:this.splashRadius*.7,color:"#ff4500",particles:i})}}}const D={runner:{name:"Бегун",hp:30,speed:2.5,radius:8,color:"#ff6b6b",reward:10,minWave:1},soldier:{name:"Солдат",hp:60,speed:1.5,radius:10,color:"#ffa502",reward:15,minWave:1},tank:{name:"Танк",hp:200,speed:.8,radius:14,color:"#7f8c8d",reward:30,minWave:5},speeder:{name:"Спидер",hp:20,speed:4,radius:7,color:"#2ed573",reward:8,minWave:8},splitter:{name:"Делитель",hp:70,speed:1.8,radius:11,color:"#e17055",reward:18,minWave:6,special:"split",splitCount:3,splitHpRatio:.3},swarm:{name:"Рой",hp:12,speed:3,radius:5,color:"#fdcb6e",reward:3,minWave:7},healer:{name:"Целитель",hp:60,speed:1.3,radius:10,color:"#00b894",reward:22,minWave:8,special:"heal_aura",healRadius:100,healPercent:.15,healCooldown:4},berserker:{name:"Берсерк",hp:90,speed:1.5,radius:10,color:"#d63031",reward:20,minWave:9,special:"enrage"},armored:{name:"Бронированный",hp:120,speed:1,radius:12,color:"#636e72",reward:25,minWave:10,special:"armor",armor:5},teleporter:{name:"Телепортер",hp:45,speed:1.2,radius:9,color:"#6c5ce7",reward:20,minWave:11,special:"teleport",teleportCooldown:5,teleportJump:3},shaman:{name:"Шаман",hp:80,speed:1.2,radius:10,color:"#a855f7",reward:25,minWave:7,special:"shield_aura",auraRadius:120,auraDuration:2,auraCooldown:6},necro:{name:"Некромант",hp:100,speed:1,radius:11,color:"#6c5ce7",reward:30,minWave:12,special:"death_spawn",deathSpawnCount:2},phantom:{name:"Фантом",hp:50,speed:2,radius:9,color:"#74b9ff",reward:20,minWave:10,special:"phase",phaseOn:2,phaseOff:3},miniboss:{name:"Страж",hp:350,speed:.9,radius:16,color:"#fd79a8",reward:60,minWave:5,isMini:!0},knight:{name:"Рыцарь",hp:250,speed:.8,radius:15,color:"#b2bec3",reward:50,minWave:8,special:"armor",armor:8,isMini:!0},champion:{name:"Чемпион",hp:300,speed:1,radius:16,color:"#e84393",reward:55,minWave:12,special:"enrage",isMini:!0},oracle:{name:"Оракул",hp:200,speed:1.1,radius:14,color:"#f39c12",reward:50,minWave:15,special:"mass_shield",massShieldDuration:3,isMini:!0},executioner:{name:"Палач",hp:280,speed:.9,radius:15,color:"#2d3436",reward:55,minWave:18,special:"tower_disable",disableRadius:150,disableDuration:3,isMini:!0},voidguard:{name:"Страж Бездны",hp:250,speed:.7,radius:16,color:"#0c2461",reward:60,minWave:20,special:"teleport",teleportCooldown:4,teleportJump:4,isMini:!0},boss:{name:"Босс",hp:500,speed:.6,radius:18,color:"#e94560",reward:100,minWave:10,isBoss:!0},golem:{name:"Голем",hp:1e3,speed:.4,radius:22,color:"#8B4513",reward:200,minWave:20,special:"armor",armor:15,slowImmune:!0,isBoss:!0},hydra:{name:"Гидра",hp:1200,speed:.5,radius:20,color:"#27ae60",reward:250,minWave:30,special:"split",splitCount:2,splitHpRatio:.5,splitType:"hydra_mini",isBoss:!0},hydra_mini:{name:"Мини-гидра",hp:400,speed:.7,radius:14,color:"#2ecc71",reward:50,minWave:30,special:"split",splitCount:2,splitHpRatio:.4,splitType:"hydra_micro",isBoss:!1},hydra_micro:{name:"Микро-гидра",hp:120,speed:1,radius:10,color:"#55efc4",reward:20,minWave:30},titan:{name:"Титан",hp:1200,speed:.45,radius:24,color:"#2980b9",reward:350,minWave:40,special:"shield_self",shieldMaxHp:500,shieldRegen:.02,isBoss:!0},leviathan:{name:"Левиафан",hp:3e3,speed:.35,radius:26,color:"#8e44ad",reward:500,minWave:50,special:"tower_slow",slowAuraRadius:200,towerSlowFactor:.5,isBoss:!0},reaper:{name:"Жнец",hp:800,speed:.8,radius:18,color:"#2c3e50",reward:200,minWave:30,special:"teleport",teleportCooldown:5,teleportJump:5,slowImmune:!0,isBoss:!0},queen:{name:"Матка",hp:1800,speed:.3,radius:22,color:"#c0392b",reward:400,minWave:40,special:"spawn_walk",spawnInterval:4,isBoss:!0}},ye=["miniboss","knight","champion","oracle","executioner","voidguard"],Me=6,be=.04;class G{constructor(e,s,t=null,i){const l=D[e];this.type=e,this.name=l.name,this.radius=l.radius*(t?t.sizeMult:1),this.color=l.color,this.reward=Math.round(l.reward*(t?t.rewardMult:1));const o=1+(s-1)*.15,n=Math.min(1+(s-1)*.02,2);this.maxHp=Math.round(l.hp*o*(t?t.hpMult:1)),this.hp=this.maxHp,this.baseSpeed=l.speed*n*(t?t.speedMult:1),this.speed=this.baseSpeed,this.regenPercent=t?t.regenPercent:0,this.path=i,this.pathIndex=0,this.x=i[0].x,this.y=i[0].y,this.alive=!0,this.reachedEnd=!1,this.slowTimer=0,this.slowFactor=1,this.trail=[],this.trailTimer=0,this.damageFlash=0,this.shielded=!1,this.shieldTimer=0,this.special=l.special||null,this.slowImmune=l.slowImmune||!1,this.isBoss=l.isBoss||!1,this.isMini=l.isMini||!1,this.special==="shield_aura"&&(this.auraRadius=l.auraRadius,this.auraDuration=l.auraDuration,this.auraCooldown=l.auraCooldown,this.auraCooldownTimer=2),this.special==="phase"&&(this.phaseOn=l.phaseOn,this.phaseOff=l.phaseOff,this.phaseTimer=l.phaseOff,this.phased=!1),this.special==="death_spawn"&&(this.deathSpawnCount=l.deathSpawnCount),this.special==="split"&&(this.splitCount=l.splitCount,this.splitHpRatio=l.splitHpRatio,this.splitType=l.splitType||null),this.special==="heal_aura"&&(this.healRadius=l.healRadius,this.healPercent=l.healPercent,this.healCooldown=l.healCooldown,this.healCooldownTimer=2),this.special==="armor"&&(this.armor=l.armor),this.special==="teleport"&&(this.teleportCooldown=l.teleportCooldown,this.teleportJump=l.teleportJump,this.teleportTimer=l.teleportCooldown,this.teleportFlash=0),this.special==="mass_shield"&&(this.massShieldDuration=l.massShieldDuration,this.massShieldUsed=!1),this.special==="tower_disable"&&(this.disableRadius=l.disableRadius,this.disableDuration=l.disableDuration),this.special==="shield_self"&&(this.shieldMaxHp=Math.round(l.shieldMaxHp*o*(t?t.hpMult:1)),this.shieldHp=this.shieldMaxHp,this.shieldRegen=l.shieldRegen),this.special==="tower_slow"&&(this.slowAuraRadius=l.slowAuraRadius,this.towerSlowFactor=l.towerSlowFactor),this.special==="spawn_walk"&&(this.spawnInterval=l.spawnInterval,this.spawnTimer=l.spawnInterval,this.pendingSpawns=[]),this.waveNumber=s,this.modifiers=t}update(e,s){if(!this.alive)return;if(this.damageFlash>0&&(this.damageFlash-=e),this.shieldTimer>0&&(this.shieldTimer-=e,this.shieldTimer<=0&&(this.shielded=!1)),this.teleportFlash>0&&(this.teleportFlash-=e),this.special==="shield_aura"&&s&&(this.auraCooldownTimer-=e,this.auraCooldownTimer<=0)){this.auraCooldownTimer=this.auraCooldown;for(const h of s){if(!h.alive||h===this)continue;const r=h.x-this.x,d=h.y-this.y;Math.sqrt(r*r+d*d)<=this.auraRadius&&(h.shielded=!0,h.shieldTimer=this.auraDuration)}this.shielded=!0,this.shieldTimer=this.auraDuration,M.shieldActivate()}if(this.special==="heal_aura"&&s&&(this.healCooldownTimer-=e,this.healCooldownTimer<=0)){this.healCooldownTimer=this.healCooldown;let h=!1;for(const r of s){if(!r.alive||r===this)continue;const d=r.x-this.x,u=r.y-this.y;Math.sqrt(d*d+u*u)<=this.healRadius&&(r.hp=Math.min(r.maxHp,r.hp+r.maxHp*this.healPercent),h=!0)}h&&M.healPulse()}if(this.special==="phase"&&(this.phaseTimer-=e,this.phaseTimer<=0&&(this.phased=!this.phased,this.phaseTimer=this.phased?this.phaseOn:this.phaseOff,M.phaseToggle(this.phased))),this.special==="enrage"){const h=this.hp/this.maxHp;h<=.25?(this.speed=this.baseSpeed*2,this._enrageSounded2||(this._enrageSounded2=!0,M.enrage())):h<=.5?(this.speed=this.baseSpeed*1.5,this._enrageSounded1||(this._enrageSounded1=!0,M.enrage())):this.speed=this.baseSpeed}if(this.special==="teleport"&&(this.teleportTimer-=e,this.teleportTimer<=0)){this.teleportTimer=this.teleportCooldown;const h=Math.min(this.pathIndex+this.teleportJump,this.path.length-1);h>this.pathIndex&&(this.pathIndex=h,this.x=this.path[this.pathIndex].x,this.y=this.path[this.pathIndex].y,this.teleportFlash=.3,M.teleport())}if(this.special==="mass_shield"&&!this.massShieldUsed&&s){this.massShieldUsed=!0;for(const h of s)h.alive&&(h.shielded=!0,h.shieldTimer=this.massShieldDuration);M.massShield()}this.special==="shield_self"&&this.shieldHp<this.shieldMaxHp&&(this.shieldHp=Math.min(this.shieldMaxHp,this.shieldHp+this.shieldMaxHp*this.shieldRegen*e)),this.special==="spawn_walk"&&(this.spawnTimer-=e,this.spawnTimer<=0&&(this.spawnTimer=this.spawnInterval,this.pendingSpawns.push({path:this.path,pathIndex:this.pathIndex,x:this.x,y:this.y,wave:this.waveNumber,mods:this.modifiers}),M.queenSpawn())),this.trailTimer-=e,this.trailTimer<=0&&(this.trail.push({x:this.x,y:this.y}),this.trail.length>Me&&this.trail.shift(),this.trailTimer=be),this.slowTimer>0&&(this.slowTimer-=e,this.slowTimer<=0&&(this.slowFactor=1)),this.regenPercent>0&&this.hp<this.maxHp&&(this.hp=Math.min(this.maxHp,this.hp+this.maxHp*this.regenPercent*e));const t=this.path[this.pathIndex+1];if(!t){this.reachedEnd=!0,this.alive=!1;return}const i=t.x-this.x,l=t.y-this.y,o=Math.sqrt(i*i+l*l),n=this.speed*this.slowFactor*60*e;o<=n?(this.x=t.x,this.y=t.y,this.pathIndex++):(this.x+=i/o*n,this.y+=l/o*n)}takeDamage(e){if(!this.shielded&&!this.phased){if(this.special==="shield_self"&&this.shieldHp>0)if(e<=this.shieldHp){this.shieldHp-=e,this.damageFlash=.1;return}else e-=this.shieldHp,this.shieldHp=0;this.armor>0&&(e=Math.max(1,e-this.armor)),this.hp-=e,this.damageFlash=.1,this.hp<=0&&(this.hp=0,this.alive=!1)}}get targetable(){return this.alive&&!this.phased}applySlow(e,s){this.slowImmune||(this.slowFactor=e,this.slowTimer=s)}get progress(){return this.pathIndex/(this.path.length-1)}}class ve{constructor(e){this.type=e.type,this.type==="bullet"?(this.x=e.x,this.y=e.y,this.prevX=e.x,this.prevY=e.y,this.target=e.targetId,this.speed=e.speed,this.damage=e.damage,this.color=e.color,this.tower=e.tower,this.alive=!0,this.radius=4,this.particles=e.particles||null):this.type==="chain"?(this.points=[{x:e.startX,y:e.startY},...e.points],this.color=e.color,this.timer=e.timer,this.alive=!0,this.particles=e.particles||null,this.particles&&this.particles.emitChainSparks(this.points)):this.type==="burnzone"?(this.x=e.x,this.y=e.y,this.timer=e.duration,this.maxTimer=e.duration,this.tickTimer=0,this.tickInterval=.25,this.tickDamage=e.tickDamage,this.radius=e.radius,this.color=e.color||"#ff4500",this.alive=!0,this.particles=e.particles||null):this.type==="beam"&&(this.x=e.x,this.y=e.y,this.angle=e.angle,this.length=e.length,this.color=e.color,this.timer=e.timer,this.maxTimer=e.timer,this.alive=!0)}update(e,s){if(!this.alive)return;if(this.type==="chain"){this.timer-=e,this.timer<=0&&(this.alive=!1);return}if(this.type==="beam"){this.timer-=e,this.timer<=0&&(this.alive=!1);return}if(this.type==="burnzone"){if(this.timer-=e,this.timer<=0){this.alive=!1;return}if(this.tickTimer-=e,this.tickTimer<=0){this.tickTimer+=this.tickInterval;for(const h of s){if(!h.alive)continue;const r=h.x-this.x,d=h.y-this.y;Math.sqrt(r*r+d*d)<=this.radius+h.radius&&h.takeDamage(this.tickDamage)}}return}const t=this.target;if(!t||!t.alive){this.alive=!1;return}this.prevX=this.x,this.prevY=this.y;const i=t.x-this.x,l=t.y-this.y,o=Math.sqrt(i*i+l*l),n=this.speed*e;o<=n+t.radius?(this.alive=!1,this.hit(t,s)):(this.x+=i/o*n,this.y+=l/o*n)}hit(e,s){const t=this.tower,i=this.particles;if(t.special==="splash"){for(const l of s){if(!l.alive)continue;const o=l.x-e.x,n=l.y-e.y,h=Math.sqrt(o*o+n*n);if(h<=t.splashRadius){const r=1-h/t.splashRadius*.5;l.takeDamage(Math.round(this.damage*r))}}i&&i.emitSplash(e.x,e.y,t.splashRadius),M.splashHit()}else e.takeDamage(this.damage),i&&i.emitImpact(e.x,e.y,this.color);t.special==="slow"&&(e.applySlow(t.slowFactor,t.slowDuration),i&&i.emitFrost(e.x,e.y))}}class we{constructor(){this.waveNumber=0,this.spawning=!1,this.spawnQueue=[],this.spawnTimer=0,this.spawnInterval=.6,this.waveActive=!1,this.betweenWaves=!0,this.currentModifiers=null}startNextWave(e=null){this.waveNumber++,this.spawning=!0,this.waveActive=!0,this.betweenWaves=!1,this.currentModifiers=e,this.spawnQueue=this.generateWave(this.waveNumber,e),this.spawnTimer=0,this.spawnInterval=Math.max(.25,.6-this.waveNumber*.01),e&&e.spawnMult&&(this.spawnInterval*=e.spawnMult)}generateWave(e,s=null){const t=[];let i=5+e*2;s&&s.countMult&&(i=Math.round(i*s.countMult));const l=["runner","soldier","tank","speeder","splitter","swarm","healer","berserker","armored","teleporter"],o=["splitter","healer","berserker","armored","teleporter","swarm"],n=l.filter(f=>e>=D[f].minWave),h=o.filter(f=>e>=D[f].minWave);for(let f=0;f<i;f++){let p;if(e>=15&&h.length>0&&Math.random()<.4?p=h[Math.floor(Math.random()*h.length)]:p=n[Math.floor(Math.random()*n.length)],p==="swarm"){const c=2+Math.floor(Math.random()*3);for(let g=0;g<c;g++)t.push("swarm")}t.push(p)}const r=e>=15?2:3;if(e>=7&&e%r===0){const f=Math.min(4,Math.floor(e/8)+1);for(let p=0;p<f;p++)t.splice(Math.floor(t.length/2),0,"shaman")}const d=e>=15?1:2;if(e>=10&&e%d===0){const f=Math.min(5,Math.floor(e/6));for(let p=0;p<f;p++)t.splice(Math.floor(Math.random()*t.length),0,"phantom")}const u=e>=15?3:4;if(e>=12&&e%u===0){const f=Math.min(3,Math.floor(e/12)+1);for(let p=0;p<f;p++)t.splice(Math.floor(t.length/3),0,"necro")}if(e>=5&&e%10!==0){const f=ye.filter(g=>e>=D[g].minWave),p=f[Math.floor(Math.random()*f.length)],c=Math.floor(p==="executioner"?t.length*.3:t.length*.5+Math.random()*t.length*.3);if(t.splice(c,0,p),e>=15){const g=f[Math.floor(Math.random()*f.length)],y=Math.floor(g==="executioner"?t.length*.2:t.length*.4+Math.random()*t.length*.3);t.splice(y,0,g)}}if(e%10===0){const f=e%50||50;f===10?t.push("boss"):f===20?t.push("golem"):f===30?t.push("hydra"):f===40?t.push("titan"):f===50&&t.push("leviathan");const p=Math.floor((e-1)/50);for(let c=0;c<p;c++)t.push("boss")}return e>=30&&e%2===1&&Math.random()<.4&&t.push("reaper"),e>=40&&e%2===0&&e%10!==0&&Math.random()<.3&&t.push("queen"),t}update(e,s,t){if(!this.spawning&&this.waveActive){t.every(l=>!l.alive)&&this.spawnQueue.length===0&&(this.waveActive=!1,this.betweenWaves=!0,this.currentModifiers=null);return}if(this.spawning){if(this.spawnTimer-=e,this.spawnTimer<=0&&this.spawnQueue.length>0){const i=this.spawnQueue.shift(),l=B[Math.floor(Math.random()*B.length)];s(i,this.waveNumber,this.currentModifiers,l),this.spawnTimer=this.spawnInterval}this.spawnQueue.length===0&&(this.spawning=!1)}}get canStartWave(){return this.betweenWaves}}function H(a,e,s,t,i=1){const l=R(e,.4),o=R(e,.6);a.fillStyle=l,a.beginPath(),a.moveTo(-10,-14),a.lineTo(10,-14),a.lineTo(14,-10),a.lineTo(14,10),a.lineTo(10,14),a.lineTo(-10,14),a.lineTo(-14,10),a.lineTo(-14,-10),a.closePath(),a.fill(),a.strokeStyle="rgba(0,0,0,0.3)",a.lineWidth=1.5,a.stroke(),a.strokeStyle="rgba(255,255,255,0.08)",a.lineWidth=.7,a.beginPath(),a.moveTo(-10,-6),a.lineTo(10,-6),a.stroke(),a.beginPath(),a.moveTo(-10,6),a.lineTo(10,6),a.stroke(),a.fillStyle=e,a.beginPath(),a.arc(0,0,9,0,Math.PI*2),a.fill(),a.strokeStyle="rgba(255,255,255,0.12)",a.lineWidth=1,a.stroke(),a.fillStyle="rgba(255,255,255,0.3)";for(let h=0;h<6;h++){const r=h*Math.PI/3;a.beginPath(),a.arc(Math.cos(r)*7,Math.sin(r)*7,.8,0,Math.PI*2),a.fill()}a.save(),a.rotate(s),a.fillStyle=o,a.beginPath(),a.moveTo(-1,-6),a.lineTo(10,-4),a.lineTo(10,4),a.lineTo(-1,6),a.closePath(),a.fill(),a.fillStyle="#a0a0a0",a.beginPath(),a.roundRect(8,-3,16,6,1.5),a.fill(),a.strokeStyle="#707070",a.lineWidth=.8;for(let h=11;h<=21;h+=2.5)a.beginPath(),a.moveTo(h,-2.5),a.lineTo(h,2.5),a.stroke();a.fillStyle="#555",a.beginPath(),a.roundRect(23,-3.5,3,7,1),a.fill(),a.fillStyle="#222",a.beginPath(),a.arc(25,0,2,0,Math.PI*2),a.fill(),a.fillStyle=l,a.globalAlpha=.7,a.beginPath(),a.moveTo(4,-7),a.lineTo(12,-5.5),a.lineTo(12,-4),a.lineTo(4,-5),a.closePath(),a.fill(),a.beginPath(),a.moveTo(4,7),a.lineTo(12,5.5),a.lineTo(12,4),a.lineTo(4,5),a.closePath(),a.fill(),a.globalAlpha=1;const n=Math.sin(t*14)*.5+.5;if(n>.6){const h=(n-.6)*2;a.fillStyle=`rgba(255,180,40,${h})`,a.beginPath(),a.arc(27,0,3,0,Math.PI*2),a.fill(),a.fillStyle=`rgba(255,255,150,${h*.6})`,a.beginPath(),a.arc(27,0,1.5,0,Math.PI*2),a.fill()}a.restore(),a.fillStyle="#4ade80",a.globalAlpha=.5+Math.sin(t*3)*.3,a.beginPath(),a.arc(0,0,2,0,Math.PI*2),a.fill(),a.globalAlpha=1}function q(a,e,s,t,i=1){a.fillStyle=e,a.strokeStyle="rgba(255,255,255,0.2)",a.lineWidth=1.5,a.beginPath();for(let l=0;l<8;l++){const o=l*Math.PI/4+Math.PI/8,n=Math.cos(o)*12,h=Math.sin(o)*12;l===0?a.moveTo(n,h):a.lineTo(n,h)}a.closePath(),a.fill(),a.stroke(),a.beginPath(),a.arc(0,0,7,0,Math.PI*2),a.fillStyle=R(e,.4),a.fill(),a.strokeStyle="rgba(255,255,255,0.15)",a.lineWidth=1;for(let l=0;l<4;l++){const o=l*Math.PI/4;a.beginPath(),a.moveTo(Math.cos(o)*2,Math.sin(o)*2),a.lineTo(Math.cos(o)*5,Math.sin(o)*5),a.stroke()}a.save(),a.rotate(s),a.fillStyle="#b0b0b0",a.fillRect(6,-4.5,15,9),a.strokeStyle="rgba(0,0,0,0.2)",a.lineWidth=.5,a.strokeRect(6,-4.5,15,9),a.fillStyle="#909090",a.fillRect(10,-5,2,10),a.fillRect(16,-5,2,10),a.fillStyle="#666",a.beginPath(),a.arc(21,0,4.5,0,Math.PI*2),a.fill(),a.fillStyle="#333",a.beginPath(),a.arc(21,0,2.5,0,Math.PI*2),a.fill(),a.restore()}function F(a,e,s,t,i=1){const l=R(e,.4),o=R(e,.6);a.fillStyle=l,a.beginPath();for(let n=0;n<3;n++){const h=n*2*Math.PI/3-Math.PI/2;n===0?a.moveTo(Math.cos(h)*14,Math.sin(h)*14):a.lineTo(Math.cos(h)*14,Math.sin(h)*14)}a.closePath(),a.fill(),a.strokeStyle="rgba(255,255,255,0.15)",a.lineWidth=1,a.stroke(),a.strokeStyle=o,a.lineWidth=2.5;for(let n=0;n<3;n++){const h=n*2*Math.PI/3-Math.PI/2;a.beginPath(),a.moveTo(0,0),a.lineTo(Math.cos(h)*12,Math.sin(h)*12),a.stroke()}a.fillStyle=e,a.beginPath(),a.arc(0,0,7,0,Math.PI*2),a.fill(),a.strokeStyle="rgba(255,255,255,0.12)",a.lineWidth=.8,a.stroke(),a.save(),a.rotate(s),a.fillStyle=o,a.beginPath(),a.roundRect(-1,-4,8,8,2),a.fill(),a.fillStyle="#a0a0a0",a.beginPath(),a.roundRect(6,-1.5,22,3,1),a.fill(),a.fillStyle="#888",a.beginPath(),a.roundRect(8,-3,6,6,1.5),a.fill(),a.strokeStyle="rgba(0,0,0,0.2)",a.lineWidth=.5,a.beginPath(),a.moveTo(15,-.5),a.lineTo(26,-.5),a.stroke(),a.beginPath(),a.moveTo(15,.5),a.lineTo(26,.5),a.stroke(),a.fillStyle="#666",a.beginPath(),a.roundRect(26,-3,4,6,1),a.fill(),a.strokeStyle="#444",a.lineWidth=.8,a.beginPath(),a.moveTo(27,-2.5),a.lineTo(27,2.5),a.stroke(),a.beginPath(),a.moveTo(29,-2.5),a.lineTo(29,2.5),a.stroke(),a.fillStyle="#555",a.beginPath(),a.roundRect(10,-6.5,8,3,1.5),a.fill(),a.fillStyle="#5dade2",a.globalAlpha=.5+Math.sin(t*3)*.3,a.beginPath(),a.arc(11,-5,1.5,0,Math.PI*2),a.fill(),a.beginPath(),a.arc(17,-5,1.5,0,Math.PI*2),a.fill(),a.globalAlpha=1,a.fillStyle="#666",a.fillRect(13,-3.5,1.5,2),a.restore(),a.strokeStyle="#5dade2",a.globalAlpha=.4+Math.sin(t*2)*.2,a.lineWidth=.8,a.beginPath(),a.moveTo(-4,0),a.lineTo(-1.5,0),a.stroke(),a.beginPath(),a.moveTo(1.5,0),a.lineTo(4,0),a.stroke(),a.beginPath(),a.moveTo(0,-4),a.lineTo(0,-1.5),a.stroke(),a.beginPath(),a.moveTo(0,1.5),a.lineTo(0,4),a.stroke(),a.globalAlpha=1}function O(a,e,s,t,i=1){a.fillStyle=e,a.strokeStyle="rgba(255,255,255,0.2)",a.lineWidth=1.5,a.beginPath();for(let n=0;n<6;n++){const h=n*Math.PI/3;n===0?a.moveTo(Math.cos(h)*13,Math.sin(h)*13):a.lineTo(Math.cos(h)*13,Math.sin(h)*13)}a.closePath(),a.fill(),a.stroke(),a.strokeStyle=R(e,.3),a.lineWidth=2,a.beginPath(),a.arc(0,0,9,0,Math.PI*2),a.stroke(),a.strokeStyle=R(e,.2),a.lineWidth=1,a.beginPath(),a.arc(0,0,5,0,Math.PI*2),a.stroke();const o=3.5+Math.sin(t*6)*1.5;a.beginPath(),a.arc(0,0,o,0,Math.PI*2),a.fillStyle="#fff",a.globalAlpha=.7+Math.sin(t*8)*.2,a.fill(),a.globalAlpha=1,a.strokeStyle=e,a.lineWidth=1.2,a.globalAlpha=.35+Math.sin(t*10)*.2;for(let n=0;n<6;n++){const h=n*Math.PI/3,r=Math.cos(h)*13,d=Math.sin(h)*13,u=Math.sin(t*15+n*2)*4,f=Math.cos(t*12+n*3)*3;a.beginPath(),a.moveTo(0,0),a.bezierCurveTo(r*.3+u,d*.3+f,r*.6-f,d*.6+u,r,d),a.stroke()}a.globalAlpha=1}function R(a,e){const s=parseInt(a.slice(1,3),16),t=parseInt(a.slice(3,5),16),i=parseInt(a.slice(5,7),16);return`rgb(${Math.round(s*(1-e))},${Math.round(t*(1-e))},${Math.round(i*(1-e))})`}let $=[];function Te(){$=[];const e=(s=>()=>(s=s*16807%2147483647,s/2147483647))(42);for(let s=0;s<w;s++)for(let t=0;t<_;t++)S[s][t]===0&&e()<.25&&$.push({x:t*m+e()*m,y:s*m+e()*m,h:2+e()*3,alpha:.06+e()*.06})}class Pe{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),e.width=_*m,e.height=w*m,this.time=0}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}drawMap(){const e=this.ctx,s=this.time;for(let t=0;t<w;t++)for(let i=0;i<_;i++){const l=i*m,o=t*m,n=S[t][i];n===1?e.fillStyle="#1e1e2e":n===2?e.fillStyle=`rgba(42,157,92,${.55+Math.sin(s*3)*.15})`:n===3?e.fillStyle=`rgba(214,48,49,${.55+Math.sin(s*3)*.15})`:n===4?e.fillStyle="#171d28":e.fillStyle="#141c26",e.fillRect(l,o,m,m),e.strokeStyle="rgba(255,255,255,0.02)",e.lineWidth=.5,e.strokeRect(l,o,m,m)}for(const t of $)e.globalAlpha=t.alpha,e.fillStyle="#2a5a3a",e.fillRect(t.x,t.y,1,-t.h),e.fillRect(t.x+2,t.y,1,-t.h*.7),e.globalAlpha=1;for(const t of B)this.drawPathArrows(e,s,t);for(const t of B)this.drawEndGlow(e,t[0].x,t[0].y,"#2ecc71",s),this.drawEndGlow(e,t[t.length-1].x,t[t.length-1].y,"#e74c3c",s)}drawPathArrows(e,s,t){const i=s*40;e.strokeStyle="rgba(255,255,255,0.05)",e.lineWidth=1;for(let l=0;l<t.length-1;l++){const o=t[l],n=t[l+1],h=n.x-o.x,r=n.y-o.y,d=Math.sqrt(h*h+r*r);if(d<1)continue;const u=h/d,f=r/d,p=i%20;for(let c=-p;c<d;c+=20){if(c<2||c>d-2)continue;const g=o.x+u*c,y=o.y+f*c;e.beginPath(),e.moveTo(g-f*4-u*4,y+u*4-f*4),e.lineTo(g,y),e.lineTo(g+f*4-u*4,y-u*4-f*4),e.stroke()}}}drawEndGlow(e,s,t,i,l){const o=m*.55+Math.sin(l*2)*3;e.beginPath(),e.arc(s,t,o,0,Math.PI*2),e.fillStyle=i,e.globalAlpha=.08+Math.sin(l*2.5)*.04,e.fill(),e.globalAlpha=1}drawTowers(e,s,t){const i=this.ctx;for(const l of e){const{x:o,y:n,color:h,angle:r,type:d,cooldown:u,fireRate:f,level:p}=l;switch(t&&t.compatibles.includes(l)&&(i.beginPath(),i.arc(o,n,22,0,Math.PI*2),i.fillStyle=h,i.globalAlpha=.3+Math.sin(s*6)*.15,i.fill(),i.globalAlpha=1,i.beginPath(),i.arc(o,n,24+Math.sin(s*6)*2,0,Math.PI*2),i.strokeStyle=h,i.lineWidth=2,i.globalAlpha=.7+Math.sin(s*6)*.2,i.stroke(),i.globalAlpha=1),t&&t.tower===l&&(i.globalAlpha=.3),i.beginPath(),i.ellipse(o+2,n+2,14,10,0,0,Math.PI*2),i.fillStyle="rgba(0,0,0,0.3)",i.fill(),i.beginPath(),i.arc(o,n,17,0,Math.PI*2),i.fillStyle="#0c1018",i.fill(),i.strokeStyle="rgba(255,255,255,0.05)",i.lineWidth=1,i.stroke(),u>f-.08&&(i.beginPath(),i.arc(o,n,22,0,Math.PI*2),i.fillStyle=h,i.globalAlpha=.12,i.fill(),i.globalAlpha=1),i.save(),i.translate(o,n),l.disabledTimer>0&&(i.globalAlpha=.4),d){case"gun":H(i,h,r,s,p);break;case"cannon":q(i,h,r,s,p);break;case"sniper":F(i,h,r,s,p);break;case"tesla":O(i,h,r,s,p);break}if(l.disabledTimer>0&&(i.globalAlpha=1,i.beginPath(),i.arc(0,0,16,0,Math.PI*2),i.fillStyle="rgba(255,0,0,0.2)",i.fill(),i.strokeStyle="#ff0000",i.lineWidth=1.5,i.beginPath(),i.moveTo(-8,-8),i.lineTo(8,8),i.stroke(),i.beginPath(),i.moveTo(8,-8),i.lineTo(-8,8),i.stroke()),p>=2){const g={2:"#00ffcc",3:"#ff9900",4:"#ff00ff"}[p];i.strokeStyle=g,i.lineWidth=1.5,i.globalAlpha=.4+Math.sin(s*3)*.2,i.beginPath(),i.arc(0,0,16,0,Math.PI*2),i.stroke(),i.globalAlpha=1}if(p>=3&&(i.strokeStyle="#ff9900",i.lineWidth=1,i.globalAlpha=.3+Math.sin(s*5)*.15,i.beginPath(),i.arc(0,0,19+Math.sin(s*5)*1,0,Math.PI*2),i.stroke(),i.globalAlpha=1),p===4){i.save(),i.rotate(s*2),i.strokeStyle="#ff00ff",i.lineWidth=2,i.globalAlpha=.5+Math.sin(s*8)*.3;for(let c=0;c<4;c++){const g=c*Math.PI*2/4;i.beginPath(),i.arc(0,0,20,g,g+Math.PI/5),i.stroke()}i.globalAlpha=1,i.restore()}if(i.restore(),t&&t.tower===l&&(i.globalAlpha=1),p>1){const g={2:"#00ffcc",3:"#ff9900",4:"#ff00ff"}[p];for(let y=0;y<p-1;y++){const k=o+10+y*5,v=n-15;i.beginPath(),i.arc(k,v,2.5,0,Math.PI*2),i.fillStyle=g,i.fill()}}}if(t){const{tower:l,currentX:o,currentY:n}=t;switch(i.save(),i.globalAlpha=.6,i.translate(o,n),i.beginPath(),i.arc(0,0,17,0,Math.PI*2),i.fillStyle="#0c1018",i.fill(),l.type){case"gun":H(i,l.color,l.angle,s,l.level);break;case"cannon":q(i,l.color,l.angle,s,l.level);break;case"sniper":F(i,l.color,l.angle,s,l.level);break;case"tesla":O(i,l.color,l.angle,s,l.level);break}i.restore()}}drawEnemies(e,s){const t=this.ctx;for(const i of e){if(!i.alive)continue;const{x:l,y:o,radius:n,color:h,type:r,hp:d,maxHp:u,slowTimer:f}=i;if(i.trail&&i.trail.length>1){for(let c=0;c<i.trail.length;c++){const g=i.trail[c],y=(c+1)/i.trail.length;t.beginPath(),t.arc(g.x,g.y,n*y*.5,0,Math.PI*2),t.fillStyle=f>0?"#74b9ff":h,t.globalAlpha=.08*y,t.fill()}t.globalAlpha=1}t.beginPath(),t.ellipse(l+1,o+n*.6,n*.75,n*.3,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0.2)",t.fill();const p=i.damageFlash>0?"#fff":f>0?"#74b9ff":h;switch(t.save(),t.translate(l,o),i.phased&&(t.globalAlpha=.25),r){case"runner":this._enemyRunner(t,p,n,s);break;case"soldier":this._enemySoldier(t,p,n,s);break;case"tank":this._enemyTank(t,p,n,s);break;case"speeder":this._enemySpeeder(t,p,n,s);break;case"splitter":this._enemySplitter(t,p,n,s);break;case"swarm":this._enemySwarm(t,p,n,s);break;case"healer":this._enemyHealer(t,p,n,s);break;case"berserker":this._enemyBerserker(t,p,n,s,i.hp/i.maxHp);break;case"armored":this._enemyArmored(t,p,n,s);break;case"teleporter":this._enemyTeleporter(t,p,n,s,i.teleportFlash);break;case"shaman":this._enemyShaman(t,p,n,s);break;case"necro":this._enemyNecro(t,p,n,s);break;case"phantom":this._enemyPhantom(t,p,n,s,i.phased);break;case"miniboss":this._enemyMiniboss(t,p,n,s);break;case"knight":this._enemyKnight(t,p,n,s);break;case"champion":this._enemyChampion(t,p,n,s,i.hp/i.maxHp);break;case"oracle":this._enemyOracle(t,p,n,s);break;case"executioner":this._enemyExecutioner(t,p,n,s);break;case"voidguard":this._enemyVoidguard(t,p,n,s);break;case"boss":this._enemyBoss(t,p,n,s);break;case"golem":this._enemyGolem(t,p,n,s);break;case"hydra":case"hydra_mini":case"hydra_micro":this._enemyHydra(t,p,n,s,r);break;case"titan":this._enemyTitan(t,p,n,s,i);break;case"leviathan":this._enemyLeviathan(t,p,n,s);break;case"reaper":this._enemyReaper(t,p,n,s);break;case"queen":this._enemyQueen(t,p,n,s);break;default:t.beginPath(),t.arc(0,0,n,0,Math.PI*2),t.fillStyle=p,t.fill()}if(i.phased&&(t.globalAlpha=1),t.restore(),i.shielded&&i.shieldTimer>0&&(t.beginPath(),t.arc(l,o,n+5,0,Math.PI*2),t.strokeStyle="#a855f7",t.lineWidth=2,t.globalAlpha=.5+Math.sin(s*8)*.3,t.stroke(),t.globalAlpha=.1,t.fillStyle="#a855f7",t.fill(),t.globalAlpha=1),d<u){const c=n*2.4,g=3,y=l-c/2,k=o-n-7,v=d/u;t.fillStyle="rgba(0,0,0,0.55)",this._roundRect(t,y-1,k-1,c+2,g+2,2),t.fill(),t.fillStyle=v>.5?"#2ecc71":v>.25?"#f39c12":"#e74c3c",c*v>.5&&(this._roundRect(t,y,k,c*v,g,1.5),t.fill())}if(i.special==="shield_self"&&i.shieldMaxHp>0){const c=n*2.4,g=2.5,y=l-c/2,k=o-n-12,v=i.shieldHp/i.shieldMaxHp;t.fillStyle="rgba(0,0,0,0.55)",this._roundRect(t,y-1,k-1,c+2,g+2,2),t.fill(),t.fillStyle="#3498db",c*v>.5&&(this._roundRect(t,y,k,c*v,g,1.5),t.fill())}i.armor>0&&(t.beginPath(),t.arc(l,o,n+2,0,Math.PI*2),t.strokeStyle="rgba(192,192,192,0.4)",t.lineWidth=2,t.stroke())}}_enemyRunner(e,s,t){e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.fillStyle=s,e.fill(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1,e.stroke(),e.beginPath(),e.arc(0,0,t*.55,0,Math.PI*2),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=.8,e.stroke(),e.beginPath(),e.arc(-t*.25,-t*.25,t*.2,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.2)",e.fill()}_enemySoldier(e,s,t){e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.fillStyle=s,e.fill(),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1.5,e.stroke(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1.5,e.beginPath(),e.moveTo(-t*.4,-t*.15),e.lineTo(0,t*.2),e.lineTo(t*.4,-t*.15),e.stroke()}_enemyTank(e,s,t){const i=t*.8;this._roundRect(e,-i,-i,i*2,i*2,3),e.fillStyle=s,e.fill(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=2,e.stroke(),e.fillStyle="rgba(255,255,255,0.06)",e.fillRect(-i,-1.5,i*2,3),e.fillRect(-1.5,-i,3,i*2)}_enemySpeeder(e,s,t){e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1,e.beginPath();for(let i=0;i<3;i++){const l=i*2*Math.PI/3-Math.PI/2;i===0?e.moveTo(Math.cos(l)*t,Math.sin(l)*t):e.lineTo(Math.cos(l)*t,Math.sin(l)*t)}e.closePath(),e.fill(),e.stroke(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1,e.beginPath(),e.moveTo(0,-t*.45),e.lineTo(0,t*.35),e.moveTo(-t*.2,-t*.15),e.lineTo(0,-t*.45),e.lineTo(t*.2,-t*.15),e.stroke()}_enemyShaman(e,s,t,i){e.beginPath(),e.arc(0,0,t+8+Math.sin(i*3)*3,0,Math.PI*2),e.strokeStyle=s,e.globalAlpha=.15+Math.sin(i*4)*.1,e.lineWidth=1.5,e.stroke(),e.globalAlpha=1,e.save(),e.rotate(Math.PI/4);const l=t*.85;e.fillStyle=s,e.fillRect(-l,-l,l*2,l*2),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1.5,e.strokeRect(-l,-l,l*2,l*2),e.restore(),e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=1;for(let n=0;n<4;n++){const h=n*Math.PI/2;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(h)*t*.6,Math.sin(h)*t*.6),e.stroke()}const o=2.5+Math.sin(i*5)*1;e.beginPath(),e.arc(0,0,o,0,Math.PI*2),e.fillStyle="#e8daef",e.globalAlpha=.8,e.fill(),e.globalAlpha=1}_enemyNecro(e,s,t,i){e.beginPath(),e.arc(0,0,t+4,0,Math.PI*2),e.fillStyle="#1a1a2e",e.globalAlpha=.3,e.fill(),e.globalAlpha=1,e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1.5,e.beginPath();for(let l=0;l<6;l++){const o=l*Math.PI/3-Math.PI/6;l===0?e.moveTo(Math.cos(o)*t,Math.sin(o)*t):e.lineTo(Math.cos(o)*t,Math.sin(o)*t)}e.closePath(),e.fill(),e.stroke(),e.strokeStyle="#2d1b69",e.lineWidth=2,e.beginPath(),e.moveTo(0,-t*.4),e.lineTo(0,t*.45),e.stroke(),e.beginPath(),e.moveTo(-t*.3,-t*.1),e.lineTo(t*.3,-t*.1),e.stroke(),e.fillStyle="#bb86fc",e.globalAlpha=.5+Math.sin(i*6)*.3,e.beginPath(),e.arc(-t*.2,-t*.35,1.5,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.2,-t*.35,1.5,0,Math.PI*2),e.fill(),e.globalAlpha=1}_enemyPhantom(e,s,t,i,l){e.fillStyle=s,e.beginPath(),e.arc(0,-t*.15,t*.8,Math.PI,0);const o=t*.55;e.lineTo(t*.8,o);for(let n=3;n>=-3;n--){const h=n/3*t*.8,r=o+Math.sin(n+i*5)*t*.2;e.lineTo(h,r)}e.lineTo(-t*.8,o),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1,e.stroke(),l||(e.fillStyle="rgba(255,255,255,0.6)",e.beginPath(),e.arc(-t*.25,-t*.2,2,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.25,-t*.2,2,0,Math.PI*2),e.fill())}_enemyMiniboss(e,s,t,i){e.beginPath(),e.arc(0,0,t+3,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=.1+Math.sin(i*3)*.05,e.fill(),e.globalAlpha=1,e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=2,e.beginPath();for(let l=0;l<6;l++){const o=l*Math.PI/3-Math.PI/2,n=l%2===0?t:t*.55;l===0?e.moveTo(Math.cos(o)*n,Math.sin(o)*n):e.lineTo(Math.cos(o)*n,Math.sin(o)*n)}e.closePath(),e.fill(),e.stroke(),e.fillStyle="rgba(0,0,0,0.2)",e.beginPath(),e.arc(0,0,t*.4,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1.5,e.beginPath(),e.arc(0,0,t*.4,0,Math.PI*2),e.stroke(),e.save(),e.rotate(i*2),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(-t*.25,0),e.lineTo(t*.25,0),e.moveTo(0,-t*.25),e.lineTo(0,t*.25),e.stroke(),e.restore()}_enemyBoss(e,s,t,i){const l=t+8+Math.sin(i*2)*3;e.beginPath(),e.arc(0,0,l,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=.12,e.fill(),e.globalAlpha=1,e.save(),e.rotate(i*.8),e.strokeStyle=s,e.lineWidth=1.5,e.globalAlpha=.2,e.beginPath(),e.arc(0,0,t+4,0,Math.PI*1.2),e.stroke(),e.beginPath(),e.arc(0,0,t+4,Math.PI*1.5,Math.PI*2),e.stroke(),e.globalAlpha=1,e.restore(),e.save(),e.rotate(-i*1.2),e.strokeStyle="#fff",e.lineWidth=1,e.globalAlpha=.12,e.beginPath(),e.arc(0,0,t+2,.5,Math.PI*.8+.5),e.stroke(),e.globalAlpha=1,e.restore();const o=e.createRadialGradient(0,-t*.3,0,0,0,t);o.addColorStop(0,"#ff6b81"),o.addColorStop(.7,s),o.addColorStop(1,"#8b0000"),e.fillStyle=o,e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=2.5,e.beginPath();for(let r=0;r<5;r++){const d=r*2*Math.PI/5-Math.PI/2;r===0?e.moveTo(Math.cos(d)*t,Math.sin(d)*t):e.lineTo(Math.cos(d)*t,Math.sin(d)*t)}e.closePath(),e.fill(),e.stroke(),e.save(),e.rotate(i*1.5),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1.5,e.beginPath();for(let r=0;r<5;r++){const d=r*4*Math.PI/5-Math.PI/2;r===0?e.moveTo(Math.cos(d)*t*.55,Math.sin(d)*t*.55):e.lineTo(Math.cos(d)*t*.55,Math.sin(d)*t*.55)}e.closePath(),e.stroke(),e.restore(),e.strokeStyle="rgba(255,255,255,0.08)",e.lineWidth=1;for(let r=0;r<5;r++){const d=r*2*Math.PI/5-Math.PI/2;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(d)*t*.9,Math.sin(d)*t*.9),e.stroke()}const n=4+Math.sin(i*5)*2,h=e.createRadialGradient(0,0,0,0,0,n+2);h.addColorStop(0,"#fff"),h.addColorStop(.5,"#ffaaaa"),h.addColorStop(1,"transparent"),e.fillStyle=h,e.globalAlpha=.8,e.beginPath(),e.arc(0,0,n+2,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.fillStyle="#fff",e.beginPath(),e.arc(0,0,n*.5,0,Math.PI*2),e.fill()}_enemySplitter(e,s,t,i){const l=1+Math.sin(i*4)*.05,o=t*l;for(let n=0;n<3;n++){const h=n*2*Math.PI/3-Math.PI/2+.08,r=(n+1)*2*Math.PI/3-Math.PI/2-.08;e.beginPath(),e.moveTo(0,0),e.arc(0,0,o,h,r),e.closePath(),e.fillStyle=s,e.fill(),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1,e.stroke()}e.strokeStyle="rgba(0,0,0,0.5)",e.lineWidth=2;for(let n=0;n<3;n++){const h=n*2*Math.PI/3-Math.PI/2;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(h)*o,Math.sin(h)*o),e.stroke()}e.beginPath(),e.arc(0,0,2,0,Math.PI*2),e.fillStyle="#fff",e.globalAlpha=.4,e.fill(),e.globalAlpha=1}_enemySwarm(e,s,t,i){const l=Math.sin(i*30+t)*1.5,o=Math.cos(i*25+t)*1.5;e.translate(l,o),e.fillStyle=s,e.beginPath(),e.moveTo(0,-t),e.lineTo(-t*.7,t*.6),e.lineTo(t*.7,t*.6),e.closePath(),e.fill(),e.globalAlpha=.3;const n=Math.sin(i*40)*.3;e.beginPath(),e.ellipse(-t*.6,0,t*.5,t*.25,-.5+n,0,Math.PI*2),e.fillStyle="#fff",e.fill(),e.beginPath(),e.ellipse(t*.6,0,t*.5,t*.25,.5-n,0,Math.PI*2),e.fill(),e.globalAlpha=1}_enemyHealer(e,s,t,i){const l=Math.sin(i*3);e.beginPath(),e.arc(0,0,t+6+l*3,0,Math.PI*2),e.strokeStyle=s,e.lineWidth=1,e.globalAlpha=.15+l*.1,e.stroke(),e.globalAlpha=1,e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.fillStyle=s,e.fill(),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1.5,e.stroke();const o=t*.25,n=t*.6;e.fillStyle="rgba(255,255,255,0.5)",e.fillRect(-o,-n,o*2,n*2),e.fillRect(-n,-o,n*2,o*2)}_enemyBerserker(e,s,t,i,l){const o=l<=.5,n=o?"#ff0000":s;if(l<=.25){for(let r=0;r<4;r++){const d=i*5+r*1.5,u=Math.cos(d)*t*.8,f=Math.sin(d)*t*.8-t*.3;e.beginPath(),e.arc(u,f,1.5,0,Math.PI*2),e.fillStyle="#ff6600",e.globalAlpha=.5+Math.sin(i*10+r)*.3,e.fill()}e.globalAlpha=1}e.save(),e.rotate(Math.PI/4);const h=t*.75;e.fillStyle=n,e.fillRect(-h,-h,h*2,h*2),e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=1.5,e.strokeRect(-h,-h,h*2,h*2),e.restore(),o&&(e.strokeStyle="#ff4444",e.lineWidth=2,e.beginPath(),e.moveTo(0,-t*.35),e.lineTo(-t*.2,-t*.1),e.lineTo(0,-t*.2),e.lineTo(t*.2,-t*.1),e.lineTo(0,-t*.35),e.stroke())}_enemyArmored(e,s,t,i){const l=t*.85;e.fillStyle=s,e.fillRect(-l,-l,l*2,l*2),e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=2.5,e.strokeRect(-l,-l,l*2,l*2),e.strokeStyle="rgba(255,255,255,0.12)",e.lineWidth=1,e.strokeRect(-l*.7,-l*.7,l*1.4,l*1.4);const o=[[-l*.8,-l*.8],[l*.8,-l*.8],[-l*.8,l*.8],[l*.8,l*.8]];e.fillStyle="rgba(255,255,255,0.35)";for(const[n,h]of o)e.beginPath(),e.arc(n,h,1.5,0,Math.PI*2),e.fill();e.fillStyle="rgba(255,255,255,0.06)",e.fillRect(-l,-2,l*2,4)}_enemyTeleporter(e,s,t,i,l){l>0&&(e.beginPath(),e.arc(0,0,t+8,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=l,e.fill(),e.globalAlpha=1);const o=Math.sin(i*20)>.7?(Math.random()-.5)*3:0;e.translate(o,0),e.strokeStyle=s,e.lineWidth=2;for(let n=0;n<4;n++){const h=n*Math.PI/2+i*2,r=h+Math.PI/3;e.beginPath(),e.arc(0,0,t,h,r),e.stroke()}e.beginPath(),e.arc(0,0,t*.7,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=.4,e.fill(),e.globalAlpha=1,e.beginPath(),e.arc(0,0,2.5,0,Math.PI*2),e.fillStyle="#fff",e.fill()}_enemyKnight(e,s,t,i){e.beginPath(),e.arc(0,0,t+4,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=.08,e.fill(),e.globalAlpha=1,e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=2.5,e.beginPath(),e.moveTo(0,-t),e.lineTo(t*.9,-t*.3),e.lineTo(t*.6,t*.8),e.lineTo(-t*.6,t*.8),e.lineTo(-t*.9,-t*.3),e.closePath(),e.fill(),e.stroke(),e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(0,-t*.6),e.lineTo(0,t*.5),e.stroke(),e.beginPath(),e.moveTo(-t*.4,-t*.05),e.lineTo(t*.4,-t*.05),e.stroke(),e.fillStyle="rgba(255,255,255,0.3)";const l=[[0,-t*.85],[-t*.7,-t*.15],[t*.7,-t*.15],[-t*.45,t*.65],[t*.45,t*.65]];for(const[o,n]of l)e.beginPath(),e.arc(o,n,1.5,0,Math.PI*2),e.fill()}_enemyChampion(e,s,t,i,l){const o=l<=.5;o&&(e.beginPath(),e.arc(0,0,t+5,0,Math.PI*2),e.fillStyle="#ff0000",e.globalAlpha=.1+Math.sin(i*6)*.08,e.fill(),e.globalAlpha=1),e.fillStyle=o?"#ff1744":s,e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=2,e.beginPath();for(let n=0;n<8;n++){const h=n*Math.PI/4-Math.PI/8;n===0?e.moveTo(Math.cos(h)*t,Math.sin(h)*t):e.lineTo(Math.cos(h)*t,Math.sin(h)*t)}e.closePath(),e.fill(),e.stroke(),e.fillStyle="#ffd700",e.beginPath(),e.moveTo(-t*.5,-t*.7),e.lineTo(-t*.35,-t*1.1),e.lineTo(-t*.15,-t*.8),e.lineTo(0,-t*1.15),e.lineTo(t*.15,-t*.8),e.lineTo(t*.35,-t*1.1),e.lineTo(t*.5,-t*.7),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=1,e.stroke()}_enemyOracle(e,s,t,i){e.save(),e.rotate(i*.5);for(let o=0;o<8;o++){const n=o*Math.PI/4;e.strokeStyle=s,e.globalAlpha=.15+Math.sin(i*3+o)*.1,e.lineWidth=1.5,e.beginPath(),e.moveTo(Math.cos(n)*t*.5,Math.sin(n)*t*.5),e.lineTo(Math.cos(n)*t*1.3,Math.sin(n)*t*1.3),e.stroke()}e.globalAlpha=1,e.restore(),e.fillStyle=s,e.beginPath(),e.ellipse(0,0,t,t*.6,0,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=2,e.stroke();const l=Math.sin(i*2)*t*.15;e.beginPath(),e.arc(l,0,t*.3,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(l-t*.1,-t*.1,t*.1,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.5)",e.fill()}_enemyExecutioner(e,s,t,i){for(let l=0;l<3;l++){const o=Math.sin(i*2+l*2)*t*.5,n=Math.cos(i*1.5+l*2)*t*.5+t*.3;e.beginPath(),e.arc(o,n,t*.3,0,Math.PI*2),e.fillStyle="rgba(0,0,0,0.15)",e.fill()}e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=2,e.beginPath(),e.moveTo(0,-t),e.lineTo(t*.9,t*.7),e.lineTo(-t*.9,t*.7),e.closePath(),e.fill(),e.stroke(),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=1,e.beginPath(),e.moveTo(0,-t*.5),e.lineTo(t*.4,t*.35),e.lineTo(-t*.4,t*.35),e.closePath(),e.stroke(),e.fillStyle="#ff0000",e.globalAlpha=.7+Math.sin(i*5)*.3,e.beginPath(),e.arc(-t*.2,-t*.2,2,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.2,-t*.2,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}_enemyVoidguard(e,s,t,i){e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.strokeStyle=s,e.lineWidth=3,e.stroke(),e.beginPath(),e.arc(0,0,t*.7,0,Math.PI*2),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1.5,e.stroke(),e.beginPath(),e.arc(0,0,t*.55,0,Math.PI*2),e.fillStyle="#050510",e.fill(),e.save(),e.rotate(i*1.5),e.fillStyle=s,e.globalAlpha=.6;for(let o=0;o<6;o++){const n=o*Math.PI/3,h=Math.cos(n)*t*.85,r=Math.sin(n)*t*.85;e.fillRect(h-1.5,r-1.5,3,3)}e.globalAlpha=1,e.restore();const l=2+Math.sin(i*4)*1;e.beginPath(),e.arc(0,0,l,0,Math.PI*2),e.fillStyle="#7c3aed",e.fill()}_enemyGolem(e,s,t,i){e.beginPath(),e.arc(0,0,t+6,0,Math.PI*2),e.fillStyle="#ff6600",e.globalAlpha=.08+Math.sin(i*2)*.04,e.fill(),e.globalAlpha=1;const l=t*.45,o=[[0,0],[-l*1.5,-l*.5],[l*1.5,-l*.5],[-l*.75,l*1.1],[l*.75,l*1.1],[0,-l*1.3]];for(const[n,h]of o){e.fillStyle=s,e.strokeStyle="rgba(0,0,0,0.4)",e.lineWidth=1.5,e.beginPath();for(let r=0;r<6;r++){const d=r*Math.PI/3,u=n+Math.cos(d)*l*.55,f=h+Math.sin(d)*l*.55;r===0?e.moveTo(u,f):e.lineTo(u,f)}e.closePath(),e.fill(),e.stroke()}e.strokeStyle="#ff4500",e.lineWidth=1.5,e.globalAlpha=.5+Math.sin(i*3)*.3,e.beginPath(),e.moveTo(-t*.3,-t*.6),e.lineTo(0,0),e.lineTo(t*.4,-t*.4),e.stroke(),e.beginPath(),e.moveTo(0,0),e.lineTo(-t*.2,t*.5),e.stroke(),e.beginPath(),e.moveTo(0,0),e.lineTo(t*.3,t*.4),e.stroke(),e.globalAlpha=1,e.fillStyle="#ff6600",e.globalAlpha=.7+Math.sin(i*5)*.3,e.beginPath(),e.arc(-t*.25,-t*.25,2.5,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.25,-t*.25,2.5,0,Math.PI*2),e.fill(),e.globalAlpha=1}_enemyHydra(e,s,t,i,l){const o=l==="hydra"?3:l==="hydra_mini"?2:1;e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=2,e.beginPath(),e.ellipse(0,t*.1,t*.7,t*.5,0,0,Math.PI*2),e.fill(),e.stroke();const n=t*.4;for(let h=0;h<o;h++){const r=o===1?0:(h-(o-1)/2)*.6,d=-Math.PI/2+r+Math.sin(i*3+h)*.1,u=t*.65,f=Math.cos(d)*u,p=Math.sin(d)*u;e.strokeStyle=s,e.lineWidth=3,e.beginPath(),e.moveTo(0,0),e.lineTo(f,p),e.stroke(),e.save(),e.translate(f,p),e.rotate(d+Math.PI/2),e.fillStyle=s,e.beginPath(),e.moveTo(0,-n),e.lineTo(-n*.5,n*.3),e.lineTo(n*.5,n*.3),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=1,e.stroke(),e.fillStyle="#ff0000",e.beginPath(),e.arc(0,-n*.3,1.5,0,Math.PI*2),e.fill(),e.restore()}}_enemyTitan(e,s,t,i,l){l.shieldHp>0&&(e.save(),e.rotate(i*1.2),e.strokeStyle="#3498db",e.lineWidth=3,e.globalAlpha=.3+l.shieldHp/l.shieldMaxHp*.4,e.beginPath(),e.arc(0,0,t+6,0,Math.PI*1.4),e.stroke(),e.beginPath(),e.arc(0,0,t+6,Math.PI*1.6,Math.PI*2.5),e.stroke(),e.globalAlpha=1,e.restore()),e.beginPath(),e.arc(0,0,t+3,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=.08,e.fill(),e.globalAlpha=1,e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=2.5,e.beginPath();for(let o=0;o<6;o++){const n=o*Math.PI/3-Math.PI/6;o===0?e.moveTo(Math.cos(n)*t,Math.sin(n)*t):e.lineTo(Math.cos(n)*t,Math.sin(n)*t)}e.closePath(),e.fill(),e.stroke(),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=1;for(let o=0;o<3;o++){const n=o*2*Math.PI/3;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(n)*t*.8,Math.sin(n)*t*.8),e.stroke()}e.save(),e.rotate(i*.8),e.strokeStyle="#3498db",e.lineWidth=1.5,e.globalAlpha=.4,e.beginPath(),e.arc(0,0,t*.35,0,Math.PI*2),e.stroke(),e.globalAlpha=1,e.restore(),e.beginPath(),e.arc(0,0,3,0,Math.PI*2),e.fillStyle="#fff",e.fill()}_enemyLeviathan(e,s,t,i){e.beginPath(),e.arc(0,0,t+12,0,Math.PI*2),e.strokeStyle=s,e.lineWidth=1,e.globalAlpha=.1+Math.sin(i*2)*.05,e.stroke(),e.globalAlpha=1;const l=5;for(let h=0;h<l;h++){const r=i*1.5+h*.8,d=Math.sin(r)*(h-2)*t*.2,u=(h-2)*t*.35,f=t*(.5-h*.05);if(e.beginPath(),e.arc(d,u,f,0,Math.PI*2),e.fillStyle=s,e.fill(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1.5,e.stroke(),h<l-1){const p=Math.sin(i*1.5+(h+1)*.8)*(h-1)*t*.2,c=(h-1)*t*.35;e.strokeStyle="#bb86fc",e.globalAlpha=.3+Math.sin(i*5+h)*.2,e.lineWidth=2,e.beginPath(),e.moveTo(d,u),e.lineTo(p,c),e.stroke(),e.globalAlpha=1}}const o=Math.sin(i*1.5)*-2*t*.2,n=-2*t*.35;e.fillStyle="#ff00ff",e.globalAlpha=.7,e.beginPath(),e.arc(o-3,n-2,2,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(o+3,n-2,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}_enemyReaper(e,s,t,i){for(let l=0;l<5;l++){const o=Math.sin(i*2+l)*t*.4,n=t*.3+l*3;e.beginPath(),e.arc(o,n,t*.25+l*1.5,0,Math.PI*2),e.fillStyle="rgba(0,0,0,0.08)",e.fill()}e.fillStyle=s,e.beginPath(),e.arc(0,-t*.2,t*.5,Math.PI,0),e.lineTo(t*.6,t*.7),e.lineTo(-t*.6,t*.7),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1.5,e.stroke(),e.fillStyle="#000",e.beginPath(),e.arc(0,-t*.15,t*.25,0,Math.PI*2),e.fill(),e.fillStyle="#ff0000",e.globalAlpha=.6+Math.sin(i*4)*.4,e.beginPath(),e.arc(-t*.1,-t*.2,2,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t*.1,-t*.2,2,0,Math.PI*2),e.fill(),e.globalAlpha=1,e.save(),e.translate(t*.4,-t*.3),e.rotate(.3+Math.sin(i*2)*.1),e.strokeStyle="#888",e.lineWidth=2,e.beginPath(),e.moveTo(0,-t*.5),e.lineTo(0,t*.8),e.stroke(),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=1.5,e.beginPath(),e.moveTo(0,-t*.5),e.quadraticCurveTo(-t*.6,-t*.3,-t*.3,-t*.1),e.stroke(),e.restore()}_enemyQueen(e,s,t,i){e.beginPath(),e.arc(0,0,t+5,0,Math.PI*2),e.fillStyle=s,e.globalAlpha=.06,e.fill(),e.globalAlpha=1;for(let n=0;n<6;n++){const h=n*Math.PI/3+i*.5,r=t*.8+Math.sin(i*3+n*2)*t*.2,d=Math.cos(h)*r,u=Math.sin(h)*r,f=Math.cos(h)*r*.5+Math.sin(i*2+n)*3,p=Math.sin(h)*r*.5+Math.cos(i*2+n)*3;e.strokeStyle=s,e.lineWidth=2,e.globalAlpha=.5,e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(f,p,d,u),e.stroke(),e.beginPath(),e.arc(d,u,2,0,Math.PI*2),e.fillStyle=s,e.fill()}e.globalAlpha=1;const l=1+Math.sin(i*3)*.08;e.fillStyle=s,e.strokeStyle="rgba(255,255,255,0.2)",e.lineWidth=2,e.beginPath(),e.ellipse(0,0,t*.7*l,t*.55*l,0,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="rgba(255,255,255,0.1)",e.beginPath(),e.ellipse(0,0,t*.4*l,t*.3*l,i*.5,0,Math.PI*2),e.fill();const o=i*.25%1;o<.1&&(e.beginPath(),e.arc(0,0,t*.8,0,Math.PI*2),e.fillStyle="#ff4444",e.globalAlpha=.3*(1-o/.1),e.fill(),e.globalAlpha=1)}drawProjectiles(e){const s=this.ctx;for(const t of e)if(t.alive)if(t.type==="chain"){s.strokeStyle=t.color,s.lineWidth=2.5,s.shadowColor=t.color,s.shadowBlur=10,s.beginPath();for(let i=0;i<t.points.length;i++){const l=t.points[i];if(i===0)s.moveTo(l.x,l.y);else{const o=t.points[i-1],n=(o.x+l.x)/2+(Math.random()-.5)*10,h=(o.y+l.y)/2+(Math.random()-.5)*10;s.quadraticCurveTo(n,h,l.x,l.y)}}s.stroke(),s.shadowBlur=0,s.strokeStyle="rgba(255,255,255,0.35)",s.lineWidth=1,s.beginPath();for(let i=0;i<t.points.length;i++)i===0?s.moveTo(t.points[i].x,t.points[i].y):s.lineTo(t.points[i].x,t.points[i].y);s.stroke()}else if(t.type==="burnzone"){const i=t.timer/t.maxTimer;s.beginPath(),s.arc(t.x,t.y,t.radius,0,Math.PI*2),s.fillStyle="#ff4500",s.globalAlpha=.25*i,s.fill(),s.strokeStyle="#ff6600",s.lineWidth=2,s.globalAlpha=.5*i,s.stroke(),s.globalAlpha=1}else if(t.type==="beam"){const i=t.timer/t.maxTimer,l=t.x+Math.cos(t.angle)*t.length,o=t.y+Math.sin(t.angle)*t.length;s.save(),s.strokeStyle=t.color,s.lineWidth=3*i,s.shadowColor=t.color,s.shadowBlur=12*i,s.globalAlpha=i,s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(l,o),s.stroke(),s.strokeStyle="rgba(255,255,255,0.8)",s.lineWidth=1,s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(l,o),s.stroke(),s.shadowBlur=0,s.globalAlpha=1,s.restore()}else t.prevX!==void 0&&(s.strokeStyle=t.color,s.lineWidth=2,s.globalAlpha=.25,s.beginPath(),s.moveTo(t.prevX,t.prevY),s.lineTo(t.x,t.y),s.stroke(),s.globalAlpha=1),s.beginPath(),s.arc(t.x,t.y,t.radius+1,0,Math.PI*2),s.fillStyle=t.color,s.shadowColor=t.color,s.shadowBlur=6,s.fill(),s.shadowBlur=0,s.beginPath(),s.arc(t.x,t.y,t.radius*.4,0,Math.PI*2),s.fillStyle="rgba(255,255,255,0.5)",s.fill()}drawPlacementPreview(e,s,t,i){const l=this.ctx,o=s*m,n=e*m,h=o+m/2,r=n+m/2;l.fillStyle=t?"rgba(46,204,113,0.2)":"rgba(233,69,96,0.2)",l.fillRect(o,n,m,m),l.strokeStyle=t?"rgba(46,204,113,0.5)":"rgba(233,69,96,0.5)",l.lineWidth=1,l.strokeRect(o+.5,n+.5,m-1,m-1),t&&i&&(l.beginPath(),l.arc(h,r,i,0,Math.PI*2),l.strokeStyle="rgba(255,255,255,0.12)",l.lineWidth=1,l.setLineDash([4,4]),l.stroke(),l.setLineDash([]),l.fillStyle="rgba(255,255,255,0.015)",l.fill())}_roundRect(e,s,t,i,l,o){e.beginPath(),e.moveTo(s+o,t),e.lineTo(s+i-o,t),e.arcTo(s+i,t,s+i,t+o,o),e.lineTo(s+i,t+l-o),e.arcTo(s+i,t+l,s+i-o,t+l,o),e.lineTo(s+o,t+l),e.arcTo(s,t+l,s,t+l-o,o),e.lineTo(s,t+o),e.arcTo(s,t,s+o,t,o),e.closePath()}render(e){if(this.time=e.time||0,this.clear(),this.drawMap(),e.particles&&e.particles.draw(this.ctx,this.time),e.placementPreview){const s=e.placementPreview;this.drawPlacementPreview(s.row,s.col,s.valid,s.range)}this.drawEnemies(e.enemies,this.time),this.drawTowers(e.towers,this.time,e.dragState||null),this.drawProjectiles(e.projectiles)}}const Se=[{id:"g_hp_30",name:"Закалка",desc:"Все враги получают +30% HP навсегда",icon:"🛡",color:"#f85149",apply:a=>{a.hpMult*=1.3}},{id:"g_speed_20",name:"Адреналин",desc:"Все враги на 20% быстрее навсегда",icon:"💨",color:"#2ed573",apply:a=>{a.speedMult*=1.2}},{id:"g_reward_25",name:"Инфляция",desc:"-25% золота за убийство навсегда",icon:"💸",color:"#e3b341",apply:a=>{a.rewardMult*=.75}},{id:"g_regen",name:"Живучесть",desc:"Все враги регенерируют 3% HP/с навсегда",icon:"💚",color:"#2ecc71",apply:a=>{a.regenPercent+=.03}},{id:"g_count_25",name:"Подкрепление",desc:"+25% врагов в каждой волне навсегда",icon:"👥",color:"#e67e22",apply:a=>{a.countMult*=1.25}},{id:"g_tower_slow",name:"Помехи",desc:"Башни стреляют на 15% медленнее навсегда",icon:"📡",color:"#a855f7",apply:a=>{a.towerFireRateMult*=1.15}},{id:"g_tower_range",name:"Туман",desc:"Дальность башен -15% навсегда",icon:"🌫",color:"#8b949e",apply:a=>{a.towerRangeMult*=.85}},{id:"g_tower_dmg",name:"Броня",desc:"Башни наносят на 15% меньше урона навсегда",icon:"🔰",color:"#5dade2",apply:a=>{a.towerDamageMult*=.85}},{id:"g_life_drain",name:"Проклятие",desc:"-2 жизни прямо сейчас",icon:"💀",color:"#da3633",apply:a=>{a.lifeDrain+=2}},{id:"g_cost_up",name:"Налог",desc:"Башни стоят на 20% дороже навсегда",icon:"💰",color:"#ffa502",apply:a=>{a.towerCostMult*=1.2}}];function _e(a=3){const e=[...Se],s=[];for(let t=0;t<a&&e.length>0;t++){const i=Math.floor(Math.random()*e.length);s.push(e.splice(i,1)[0])}return s}function ke(){return{hpMult:1,speedMult:1,countMult:1,rewardMult:1,regenPercent:0,spawnMult:1,sizeMult:1,towerFireRateMult:1,towerRangeMult:1,towerDamageMult:1,towerCostMult:1,lifeDrain:0}}const Ae=[{id:"hp_25",name:"Закалённые",desc:"+25% HP врагов",icon:"♥",color:"#f85149",apply:a=>{a.hpMult*=1.25}},{id:"hp_50",name:"Бронированные",desc:"+50% HP врагов",icon:"♥♥",color:"#da3633",apply:a=>{a.hpMult*=1.5}},{id:"speed_15",name:"Ускоренные",desc:"+15% скорости врагов",icon:"»",color:"#2ed573",apply:a=>{a.speedMult*=1.15}},{id:"speed_30",name:"Стремительные",desc:"+30% скорости врагов",icon:"»»",color:"#1abc9c",apply:a=>{a.speedMult*=1.3}},{id:"count_30",name:"Орда",desc:"+30% врагов в волне",icon:"☠",color:"#ffa502",apply:a=>{a.countMult*=1.3}},{id:"count_50",name:"Нашествие",desc:"+50% врагов в волне",icon:"☠☠",color:"#e67e22",apply:a=>{a.countMult*=1.5}},{id:"reward_down",name:"Скупые",desc:"-30% награды за убийство",icon:"◇",color:"#e3b341",apply:a=>{a.rewardMult*=.7}},{id:"regen",name:"Регенерация",desc:"Враги лечатся 2% HP/с",icon:"+",color:"#2ecc71",apply:a=>{a.regenPercent+=.02}},{id:"spawn_fast",name:"Блиц",desc:"Враги спавнятся в 2x быстрее",icon:"⚡",color:"#a855f7",apply:a=>{a.spawnMult*=.5}},{id:"size_up",name:"Гиганты",desc:"+30% размер врагов, +20% HP",icon:"▲",color:"#7f8c8d",apply:a=>{a.sizeMult*=1.3,a.hpMult*=1.2}}],Ie=[{id:"hard_hp_40",name:"Стальная кожа",desc:"+40% HP врагов",icon:"♥♥♥",color:"#da3633",apply:a=>{a.hpMult*=1.4}},{id:"hard_hp_60",name:"Неуязвимые",desc:"+60% HP врагов",icon:"🛡♥",color:"#f85149",apply:a=>{a.hpMult*=1.6}},{id:"hard_count_50",name:"Армия тьмы",desc:"+50% врагов в волне",icon:"☠☠☠",color:"#e67e22",apply:a=>{a.countMult*=1.5}},{id:"hard_count_80",name:"Вторжение",desc:"+80% врагов в волне",icon:"💀☠",color:"#ffa502",apply:a=>{a.countMult*=1.8}},{id:"hard_spawn_fast",name:"Молниеносный блиц",desc:"Спавн в 2.5x быстрее",icon:"⚡⚡",color:"#a855f7",apply:a=>{a.spawnMult*=.4}},{id:"hard_regen_5",name:"Сверхрегенерация",desc:"Враги лечатся 5% HP/с",icon:"++",color:"#2ecc71",apply:a=>{a.regenPercent+=.05}},{id:"hard_size_hp",name:"Колоссы",desc:"+40% размер, +40% HP",icon:"▲▲",color:"#7f8c8d",apply:a=>{a.sizeMult*=1.4,a.hpMult*=1.4}},{id:"hard_speed_40",name:"Буря",desc:"+40% скорости врагов",icon:"»»»",color:"#1abc9c",apply:a=>{a.speedMult*=1.4}}],W=[{id:"rare",name:"Редкая волна",color:"#58a6ff",glowColor:"rgba(88, 166, 255, 0.4)",baseChance:.25,diffMult:1.25},{id:"epic",name:"Эпическая волна",color:"#a855f7",glowColor:"rgba(168, 85, 247, 0.5)",baseChance:.1,diffMult:1.5},{id:"legendary",name:"Легендарная волна",color:"#f0883e",glowColor:"rgba(240, 136, 62, 0.6)",baseChance:.05,diffMult:2}];function Y(a){if(a<15)return null;const e=Math.floor((a-15)/10)*.1,s=Math.random(),t=W[2].baseChance+e,i=W[1].baseChance+e,l=W[0].baseChance+e;return s<t?W[2]:s<t+i?W[1]:s<t+i+l?W[0]:null}function X(a=3){const e=[...Ie],s=[];for(let t=0;t<a&&e.length>0;t++){const i=Math.floor(Math.random()*e.length);s.push(e.splice(i,1)[0])}return s}function U(a=3){const e=[...Ae],s=[];for(let t=0;t<a&&e.length>0;t++){const i=Math.floor(Math.random()*e.length);s.push(e.splice(i,1)[0])}return s}function Q(){return{hpMult:1,speedMult:1,countMult:1,rewardMult:1,regenPercent:0,spawnMult:1,sizeMult:1}}const J={gun:H,cannon:q,sniper:F,tesla:O},E=160;class Re{constructor(e){this.game=e,this.selectedTower=null,this.previewRafId=null,this.hudWave=document.getElementById("hud-wave"),this.hudLives=document.getElementById("hud-lives"),this.hudGold=document.getElementById("hud-gold"),this.towerPanel=document.getElementById("tower-panel"),this.previewEl=document.getElementById("tower-preview"),this.previewCanvas=document.getElementById("preview-canvas"),this.previewInfo=document.getElementById("preview-info"),this.previewCtx=this.previewCanvas.getContext("2d"),this.modifierOverlay=document.getElementById("modifier-overlay"),this.modifierCards=document.getElementById("modifier-cards"),this.previewCanvas.width=E,this.previewCanvas.height=E,this.buildTowerPanel(),this.updateHUD()}buildTowerPanel(){this.towerPanel.innerHTML="";for(const s of ue){const t=L[s],i=document.createElement("div");i.className="tower-btn",i.dataset.type=s;const l=document.createElement("canvas");l.width=32,l.height=32;const o=l.getContext("2d");o.save(),o.translate(16,16),o.scale(.75,.75);const n=J[s];n&&n(o,t.color,0,0),o.restore();const h=document.createElement("span");h.className="tower-btn-name",h.textContent=t.name;const r=document.createElement("span");r.className="tower-btn-cost",r.textContent=`${t.cost}`,i.appendChild(l),i.appendChild(h),i.appendChild(r),i.addEventListener("click",()=>this.selectTower(s)),i.addEventListener("mouseenter",d=>this.showPreview(s,d)),i.addEventListener("mousemove",d=>this.movePreview(d)),i.addEventListener("mouseleave",()=>this.hidePreview()),this.towerPanel.appendChild(i)}const e=document.createElement("button");e.id="wave-btn",e.textContent="Старт волны",e.addEventListener("click",()=>this.game.onWaveButtonClick()),this.towerPanel.appendChild(e)}selectTower(e){this.game.waveManager.waveActive||(this.selectedTower=this.selectedTower===e?null:e,this.updateTowerButtons())}updateTowerButtons(){const e=this.game.waveManager.waveActive,s=this.game.globalMods?this.game.globalMods.towerCostMult:1;this.towerPanel.querySelectorAll(".tower-btn").forEach(l=>{const o=l.dataset.type,n=L[o],h=Math.floor(n.cost*s);l.classList.toggle("selected",o===this.selectedTower),l.classList.toggle("disabled",e||this.game.gold<h);const r=l.querySelector(".tower-btn-cost");r&&(r.textContent=`${h}`)});const i=document.getElementById("wave-btn");i&&(i.disabled=!this.game.waveManager.canStartWave,i.textContent=this.game.waveManager.canStartWave?this.game.waveManager.waveNumber===0?"Старт волны":"След. волна":`Волна ${this.game.waveManager.waveNumber}...`),e&&this.selectedTower&&(this.selectedTower=null,this.game.placementPreview=null)}updateHUD(){this.hudWave.textContent=`Волна: ${this.game.waveManager.waveNumber||"—"}`,this.hudLives.textContent=`HP: ${this.game.lives}`,this.hudGold.textContent=`${this.game.gold}`}showModifierCards(e=null){return new Promise(s=>{const t=e?X(3):U(3);this.modifierCards.innerHTML="";const i=document.getElementById("modifier-title");i&&(e?(i.textContent=e.name,i.style.color=e.color,i.style.textShadow=`0 0 20px ${e.glowColor}`):(i.textContent="Выберите модификатор",i.style.color="#c9d1d9",i.style.textShadow="none")),e&&M.eventWave(e.id);const l=e?e.diffMult:1;for(const o of t){const n=document.createElement("div");n.className="modifier-card",e&&n.classList.add(`event-${e.id}`);let h=o.desc;l>1&&(h=h.replace(/(\d+(?:\.\d+)?)(%)/g,(r,d,u)=>Math.round(parseFloat(d)*l)+u),h=h.replace(/(\d+(?:\.\d+)?)(x)/g,(r,d,u)=>(parseFloat(d)*l).toFixed(1)+u)),n.innerHTML=`
          <div class="modifier-card-icon" style="color:${o.color}">${o.icon}</div>
          <div class="modifier-card-name">${o.name}</div>
          <div class="modifier-card-desc">${h}</div>
        `,n.addEventListener("click",()=>{M.cardSelect(),n.classList.add("selected"),this.modifierCards.querySelectorAll(".modifier-card:not(.selected)").forEach(u=>u.classList.add("dismissed"));const d=Q();o.apply(d),e&&(d.hpMult=1+(d.hpMult-1)*l,d.speedMult=1+(d.speedMult-1)*l,d.countMult=1+(d.countMult-1)*l,d.rewardMult=1+(d.rewardMult-1)*l,d.regenPercent*=l,d.spawnMult=1+(d.spawnMult-1)*l,d.sizeMult=1+(d.sizeMult-1)*l),setTimeout(()=>{this.modifierOverlay.classList.add("hidden"),s(d)},450)}),this.modifierCards.appendChild(n)}this.modifierOverlay.classList.remove("hidden")})}autoPickModifier(e=null){const s=e?X(3):U(3),t=s[Math.floor(Math.random()*s.length)],i=Q();if(t.apply(i),e){const l=e.diffMult;i.hpMult=1+(i.hpMult-1)*l,i.speedMult=1+(i.speedMult-1)*l,i.countMult=1+(i.countMult-1)*l,i.rewardMult=1+(i.rewardMult-1)*l,i.regenPercent*=l,i.spawnMult=1+(i.spawnMult-1)*l,i.sizeMult=1+(i.sizeMult-1)*l}return i}showGlobalModifierCards(){return new Promise(e=>{const s=_e(3),t=document.getElementById("global-modifier-overlay"),i=document.getElementById("global-modifier-cards");i.innerHTML="";for(const l of s){const o=document.createElement("div");o.className="global-card-wrapper",o.innerHTML=`
          <div class="global-card-inner">
            <div class="global-card-back"></div>
            <div class="global-card-front">
              <div class="gc-icon">${l.icon}</div>
              <div class="gc-name" style="color:${l.color}">${l.name}</div>
              <div class="gc-desc">${l.desc}</div>
              <div class="gc-tag">навсегда</div>
            </div>
          </div>
        `,o.addEventListener("click",()=>{o.classList.contains("flipped")||o.classList.contains("burning")||(o.classList.add("flipped"),setTimeout(()=>{i.querySelectorAll(".global-card-wrapper").forEach(h=>{h!==o&&h.classList.add("burning")})},800),setTimeout(()=>{t.classList.add("hidden"),e(l)},3e3))}),i.appendChild(o)}t.classList.remove("hidden")})}showPreview(e,s){const t=L[e];this.previewEl.classList.remove("hidden"),this.previewInfo.innerHTML=`
      <div class="stat"><span class="stat-label">Урон:</span><span class="stat-value">${t.damage}</span></div>
      <div class="stat"><span class="stat-label">Дальность:</span><span class="stat-value">${t.range} кл</span></div>
      <div class="stat"><span class="stat-label">Скорость:</span><span class="stat-value">${(1/t.fireRate).toFixed(1)}/с</span></div>
      <div class="stat-desc">${t.description}</div>
    `,this.positionPreview(s),this.startPreviewAnimation(e,t)}positionPreview(e){const s=this.previewEl,t=12;let i=e.clientX-E/2-t,l=e.clientY-E-120;i=Math.max(t,Math.min(i,window.innerWidth-E-t*4)),l=Math.max(t,l),s.style.left=`${i}px`,s.style.top=`${l}px`}movePreview(e){this.positionPreview(e)}hidePreview(){this.previewEl.classList.add("hidden"),this.previewRafId&&(cancelAnimationFrame(this.previewRafId),this.previewRafId=null)}startPreviewAnimation(e,s){this.previewRafId&&cancelAnimationFrame(this.previewRafId);const t=this.previewCtx,i=E,l=i/2,o=i/2;let n=0,h=0;const r=[0,1,2].map(u=>({angle:u*Math.PI*2/3,r:50,speed:.7+u*.15,size:6})),d=u=>{h||(h=u);const f=(u-h)/1e3;h=u,n+=f,t.clearRect(0,0,i,i),t.fillStyle="#141e30",t.fillRect(0,0,i,i),t.beginPath(),t.arc(l,o,55,0,Math.PI*2),t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=1,t.stroke();const p=[];for(const T of r){T.angle+=T.speed*f;const A=l+Math.cos(T.angle)*T.r,C=o+Math.sin(T.angle)*T.r;p.push({x:A,y:C}),t.beginPath(),t.arc(A,C,T.size,0,Math.PI*2),t.fillStyle="#ff6b6b",t.fill(),t.strokeStyle="rgba(255,255,255,0.15)",t.lineWidth=1,t.stroke()}t.save(),t.translate(l,o);const c=Math.atan2(p[0].y-o,p[0].x-l),g=J[e];g&&g(t,s.color,c,n),t.restore();const y=n%s.fireRate,k=y<.15,v=p[0];if(k){const T=y/.15;if(s.special==="chain"){t.strokeStyle=s.color,t.lineWidth=2,t.shadowColor=s.color,t.shadowBlur=8,t.beginPath(),t.moveTo(l,o);for(const A of p)t.lineTo(A.x,A.y);t.stroke(),t.shadowBlur=0}else if(s.special==="splash"){const A=l+(v.x-l)*T,C=o+(v.y-o)*T;t.beginPath(),t.arc(A,C,4,0,Math.PI*2),t.fillStyle=s.color,t.fill(),T>.7&&(t.beginPath(),t.arc(v.x,v.y,20*(T-.7)/.3,0,Math.PI*2),t.fillStyle=`rgba(230,126,34,${.4*(1-(T-.7)/.3)})`,t.fill())}else if(s.special==="slow")t.strokeStyle=s.color,t.lineWidth=2,t.shadowColor=s.color,t.shadowBlur=6,t.beginPath(),t.moveTo(l,o),t.lineTo(v.x,v.y),t.stroke(),t.shadowBlur=0,t.beginPath(),t.arc(v.x,v.y,12,0,Math.PI*2),t.fillStyle="rgba(116,185,255,0.25)",t.fill();else{const A=l+(v.x-l)*T,C=o+(v.y-o)*T;t.beginPath(),t.arc(A,C,3,0,Math.PI*2),t.fillStyle=s.color,t.shadowColor=s.color,t.shadowBlur=4,t.fill(),t.shadowBlur=0}}else t.strokeStyle="rgba(255,255,255,0.06)",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(l,o),t.lineTo(v.x,v.y),t.stroke(),t.setLineDash([]);this.previewRafId=requestAnimationFrame(d)};this.previewRafId=requestAnimationFrame(d)}}class Ce{constructor(){this.particles=[],this.ambient=[],this.initAmbient()}initAmbient(){for(let e=0;e<40;e++)this.ambient.push({x:Math.random()*800,y:Math.random()*600,r:.5+Math.random()*1.2,alpha:.1+Math.random()*.2,speed:.1+Math.random()*.3,phase:Math.random()*Math.PI*2})}emitDeath(e,s,t,i){const l=8+Math.floor(i);for(let o=0;o<l;o++){const n=o/l*Math.PI*2+Math.random()*.5,h=40+Math.random()*80;this.particles.push({x:e,y:s,vx:Math.cos(n)*h,vy:Math.sin(n)*h,life:.4+Math.random()*.3,maxLife:.4+Math.random()*.3,r:1.5+Math.random()*2.5,color:t,type:"death"})}this.particles.push({x:e,y:s,radius:2,maxRadius:i*3,life:.3,maxLife:.3,color:t,type:"ring"})}emitImpact(e,s,t){for(let i=0;i<5;i++){const l=Math.random()*Math.PI*2,o=20+Math.random()*50;this.particles.push({x:e,y:s,vx:Math.cos(l)*o,vy:Math.sin(l)*o,life:.15+Math.random()*.15,maxLife:.2,r:1+Math.random()*1.5,color:t,type:"spark"})}}emitMuzzle(e,s,t,i){this.particles.push({x:e+Math.cos(t)*14,y:s+Math.sin(t)*14,life:.08,maxLife:.08,r:6,color:i,type:"flash"})}emitSplash(e,s,t){this.particles.push({x:e,y:s,radius:2,maxRadius:t,life:.35,maxLife:.35,color:"#e67e22",type:"ring"});for(let i=0;i<8;i++){const l=Math.random()*Math.PI*2,o=30+Math.random()*60;this.particles.push({x:e,y:s,vx:Math.cos(l)*o,vy:Math.sin(l)*o,life:.25+Math.random()*.2,maxLife:.35,r:1.5+Math.random()*2,color:Math.random()>.5?"#e67e22":"#f39c12",type:"spark"})}}emitFrost(e,s){for(let t=0;t<4;t++){const i=Math.random()*Math.PI*2;this.particles.push({x:e+Math.cos(i)*5,y:s+Math.sin(i)*5,vx:Math.cos(i)*15,vy:Math.sin(i)*15-10,life:.5+Math.random()*.3,maxLife:.6,r:1.5+Math.random(),color:"#74b9ff",type:"frost"})}}emitChainSparks(e){for(let s=0;s<e.length-1;s++){const t=e[s],i=e[s+1];for(let l=0;l<3;l++){const o=Math.random();this.particles.push({x:t.x+(i.x-t.x)*o,y:t.y+(i.y-t.y)*o,vx:(Math.random()-.5)*40,vy:(Math.random()-.5)*40,life:.15+Math.random()*.1,maxLife:.2,r:1+Math.random(),color:"#c084fc",type:"spark"})}}}update(e){for(let s=this.particles.length-1;s>=0;s--){const t=this.particles[s];if(t.life-=e,t.life<=0){this.particles.splice(s,1);continue}if(t.vx!==void 0&&(t.x+=t.vx*e,t.y+=t.vy*e,t.vx*=.95,t.vy*=.95),t.type==="ring"){const i=1-t.life/t.maxLife;t.radius=t.maxRadius*i}t.type==="frost"&&(t.vy-=15*e)}}draw(e,s){for(const t of this.ambient){const i=Math.sin(s*t.speed*3+t.phase)*.5+.5;e.beginPath(),e.arc(t.x,t.y,t.r,0,Math.PI*2),e.fillStyle=`rgba(100, 160, 255, ${t.alpha*i})`,e.fill()}for(const t of this.particles){const i=t.life/t.maxLife;t.type==="ring"?(e.beginPath(),e.arc(t.x,t.y,t.radius,0,Math.PI*2),e.strokeStyle=t.color,e.lineWidth=2*i,e.globalAlpha=i*.6,e.stroke(),e.globalAlpha=1):t.type==="flash"?(e.beginPath(),e.arc(t.x,t.y,t.r*i,0,Math.PI*2),e.fillStyle="#fff",e.globalAlpha=i,e.fill(),e.globalAlpha=1):t.type==="frost"?(e.beginPath(),e.arc(t.x,t.y,t.r,0,Math.PI*2),e.fillStyle=t.color,e.globalAlpha=i*.7,e.fill(),e.globalAlpha=1):(e.beginPath(),e.arc(t.x,t.y,t.r*Math.max(i,.3),0,Math.PI*2),e.fillStyle=t.color,e.globalAlpha=i,e.fill(),e.globalAlpha=1)}}}const x=document.getElementById("main-menu"),Z=document.getElementById("level-cards"),ee=document.getElementById("game-container");let I=null;function We(){Z.innerHTML="";for(const a of N){const e=document.createElement("div");e.className="level-card",e.style.borderColor=a.color+"40",e.innerHTML=`
      <div class="level-card-num" style="color:${a.color}">${a.id}</div>
      <div class="level-card-name">${a.name}</div>
      <div class="level-card-diff" style="color:${a.color}">${a.difficulty}</div>
      <div class="level-card-desc">${a.desc}</div>
      <div class="level-card-info">
        <span>Золото<div class="val" style="color:#e3b341">${a.startGold}</div></span>
        <span>Жизни<div class="val" style="color:#f85149">${a.startLives}</div></span>
        <span>Путей<div class="val">${a.pathCellArrays?a.pathCellArrays.length:"?"}</div></span>
      </div>
    `,e.addEventListener("mouseenter",()=>{e.style.borderColor=a.color}),e.addEventListener("mouseleave",()=>{e.style.borderColor=a.color+"40"}),e.addEventListener("click",()=>te(a.id)),Z.appendChild(e)}}function K(){I&&(I.destroy(),I=null),x.classList.remove("hidden"),ee.classList.add("hidden"),document.getElementById("game-over").classList.add("hidden")}function te(a){I&&(I.destroy(),I=null),pe(a),Te(),x.classList.add("hidden"),ee.classList.remove("hidden"),I=new Ee(a)}We();class Ee{constructor(e){this.levelId=e;const s=N.find(t=>t.id===e);this.canvas=document.getElementById("game-canvas"),this.renderer=new Pe(this.canvas),this.waveManager=new we,this.particles=new Ce,this.towers=[],this.enemies=[],this.projectiles=[],this.gold=s.startGold,this.lives=s.startLives,this.gameOver=!1,this.time=0,this.globalMods=ke(),this.placementPreview=null,this.lastTime=0,this.sellTooltip=null,this._destroyed=!1,this.dragState=null,this._dragStartPos=null,this.gameSpeed=1,this.autoWave=!1,this.ui=new Re(this),this.setupInput(),this.setupControls(),this.loop=this.loop.bind(this),this._rafId=requestAnimationFrame(this.loop)}destroy(){this._destroyed=!0,this._rafId&&cancelAnimationFrame(this._rafId),this.hideSellTooltip();for(const e of this.towers)S[e.row]&&S[e.row][e.col]===4&&(S[e.row][e.col]=0);this._onMouseMove&&this.canvas.removeEventListener("mousemove",this._onMouseMove),this._onMouseLeave&&this.canvas.removeEventListener("mouseleave",this._onMouseLeave),this._onMouseDown&&this.canvas.removeEventListener("mousedown",this._onMouseDown),this._onMouseUp&&this.canvas.removeEventListener("mouseup",this._onMouseUp),this._onClick&&this.canvas.removeEventListener("click",this._onClick),this._onContext&&this.canvas.removeEventListener("contextmenu",this._onContext)}setupInput(){this._onMouseMove=e=>{if(this.gameOver||this._destroyed)return;const s=this.canvas.getBoundingClientRect(),t=e.clientX-s.left,i=e.clientY-s.top;if(this.dragState){this.dragState.currentX=t,this.dragState.currentY=i,this.hideSellTooltip(),this.placementPreview=null;return}const{row:l,col:o}=V(t,i);if(this.waveManager.waveActive||!this.ui.selectedTower){const n=this.getTowerAt(l,o);n?this.showSellTooltip(e,n):this.hideSellTooltip()}if(this.ui.selectedTower&&!this.waveManager.waveActive){const n=L[this.ui.selectedTower],h=Math.floor(n.cost*this.globalMods.towerCostMult),r=z(l,o)&&!this.getTowerAt(l,o)&&this.gold>=h;this.placementPreview={row:l,col:o,valid:r,range:n.range*m}}else this.placementPreview=null},this._onMouseLeave=()=>{this.placementPreview=null,this.hideSellTooltip(),this.dragState=null},this._onMouseDown=e=>{if(this.gameOver||this._destroyed||e.button!==0||this.ui.selectedTower)return;const s=this.canvas.getBoundingClientRect(),t=e.clientX-s.left,i=e.clientY-s.top,{row:l,col:o}=V(t,i),n=this.getTowerAt(l,o);if(!n||n.level>=4)return;const h=this.towers.filter(r=>r!==n&&r.type===n.type&&r.level===n.level);this._dragStartPos={x:t,y:i},this.dragState={tower:n,startRow:l,startCol:o,currentX:t,currentY:i,compatibles:h},this.hideSellTooltip()},this._onMouseUp=e=>{if(!this.dragState)return;const s=this.dragState,t=this._dragStartPos;this.dragState=null,this._dragStartPos=null;const i=this.canvas.getBoundingClientRect(),l=e.clientX-i.left,o=e.clientY-i.top;if(Math.hypot(l-t.x,o-t.y)<8)return;const{row:h,col:r}=V(l,o),d=this.getTowerAt(h,r);d&&d!==s.tower&&d.type===s.tower.type&&d.level===s.tower.level&&s.tower.level<4&&this._mergeTowers(s.tower,d)},this._onClick=e=>{if(this.gameOver||this._destroyed||this.waveManager.waveActive||!this.ui.selectedTower)return;const s=this.canvas.getBoundingClientRect(),t=e.clientX-s.left,i=e.clientY-s.top,{row:l,col:o}=V(t,i),n=L[this.ui.selectedTower],h=Math.floor(n.cost*this.globalMods.towerCostMult);if(z(l,o)&&!this.getTowerAt(l,o)&&this.gold>=h){this.gold-=h;const r=new me(this.ui.selectedTower,l,o);this.towers.push(r),S[l][o]=4,M.towerPlace(),this.ui.updateHUD(),this.ui.updateTowerButtons()}},this._onContext=e=>{if(e.preventDefault(),this._destroyed)return;const s=this.canvas.getBoundingClientRect(),t=e.clientX-s.left,i=e.clientY-s.top,{row:l,col:o}=V(t,i),n=this.getTowerAt(l,o);if(n){this.sellTower(n),this.hideSellTooltip();return}this.ui.selectedTower=null,this.placementPreview=null,this.ui.updateTowerButtons()},this.canvas.addEventListener("mousemove",this._onMouseMove),this.canvas.addEventListener("mouseleave",this._onMouseLeave),this.canvas.addEventListener("mousedown",this._onMouseDown),this.canvas.addEventListener("mouseup",this._onMouseUp),this.canvas.addEventListener("click",this._onClick),this.canvas.addEventListener("contextmenu",this._onContext),document.getElementById("restart-btn").onclick=()=>{document.getElementById("game-over").classList.add("hidden"),te(this.levelId)},document.getElementById("menu-btn").onclick=()=>K(),document.getElementById("menu-btn-go").onclick=()=>K()}setupControls(){const e=document.getElementById("volume-slider");e&&e.addEventListener("input",()=>{M.setVolume(e.value/100)});const s=document.getElementById("speed-btn");s&&s.addEventListener("click",()=>{this.gameSpeed=this.gameSpeed===1?2:1,s.textContent=this.gameSpeed+"x",s.classList.toggle("active",this.gameSpeed===2)});const t=document.getElementById("auto-btn");t&&t.addEventListener("click",()=>{this.autoWave=!this.autoWave,t.classList.toggle("active",this.autoWave)})}getTowerAt(e,s){return this.towers.find(t=>t.row===e&&t.col===s)||null}_mergeTowers(e,s){S[e.row][e.col]=0,this.towers=this.towers.filter(t=>t!==e),s.cost+=e.cost,s.applyLevel(s.level+1),this.particles.emitDeath(s.x,s.y,s.color,20),M.towerMerge(),this.ui.updateHUD(),this.ui.updateTowerButtons()}sellTower(e){const s=Math.floor(e.cost*.5);this.gold+=s,S[e.row][e.col]=0,this.towers=this.towers.filter(t=>t!==e),M.towerSell(),this.ui.updateHUD(),this.ui.updateTowerButtons()}showSellTooltip(e,s){this.sellTooltip||(this.sellTooltip=document.createElement("div"),this.sellTooltip.className="sell-tooltip",document.body.appendChild(this.sellTooltip));const t=Math.floor(s.cost*.5),i=s.level>1?` [Лвл ${s.level}]`:"";this.sellTooltip.textContent=`${s.name}${i} | ПКМ — продать (${t})`,this.sellTooltip.style.left=`${e.clientX+12}px`,this.sellTooltip.style.top=`${e.clientY-28}px`,this.sellTooltip.style.display="block"}hideSellTooltip(){this.sellTooltip&&(this.sellTooltip.style.display="none")}async onWaveButtonClick(){if(!this.waveManager.canStartWave)return;const e=this.waveManager.waveNumber+1;if(e>1&&e%10===1){const i=await this.ui.showGlobalModifierCards();if(this._destroyed)return;i.apply(this.globalMods),this.globalMods.lifeDrain>0&&(this.lives=Math.max(1,this.lives-this.globalMods.lifeDrain),this.globalMods.lifeDrain=0,this.ui.updateHUD())}const s=Y(e),t=await this.ui.showModifierCards(s);this._destroyed||(t.hpMult*=this.globalMods.hpMult,t.speedMult*=this.globalMods.speedMult,t.countMult*=this.globalMods.countMult,t.rewardMult*=this.globalMods.rewardMult,t.regenPercent+=this.globalMods.regenPercent,t.spawnMult*=this.globalMods.spawnMult,t.sizeMult*=this.globalMods.sizeMult,this.waveManager.startNextWave(t),M.waveStart(),this.ui.updateTowerButtons())}createEnemy(e,s,t,i){this.enemies.push(new G(e,s,t,i))}createProjectile(e){e.particles=this.particles,this.projectiles.push(new ve(e))}update(e){if(this.gameOver||this._destroyed)return;this.time+=e,this.particles.update(e),this.waveManager.update(e,this.createEnemy.bind(this),this.enemies);for(const t of this.enemies)if(t.update(e,this.enemies),t.reachedEnd&&(this.lives--,M.lifeLost(),this.lives<=0)){this.lives=0,this.endGame();return}for(const t of this.enemies)if(t.alive&&t.special==="spawn_walk"&&t.pendingSpawns.length>0){for(const i of t.pendingSpawns){const l=new G("runner",i.wave,i.mods,i.path);l.pathIndex=i.pathIndex,l.x=i.x+(Math.random()-.5)*12,l.y=i.y+(Math.random()-.5)*12,l.reward=0,this.enemies.push(l)}t.pendingSpawns=[]}const s=[];for(let t=this.enemies.length-1;t>=0;t--){const i=this.enemies[t];if(!i.alive){if(!i.reachedEnd){if(this.gold+=i.reward,this.particles.emitDeath(i.x,i.y,i.color,i.radius),M.enemyDeath(),i.special==="death_spawn"&&i.deathSpawnCount>0)for(let l=0;l<i.deathSpawnCount;l++)s.push({type:"runner",path:i.path,pathIndex:i.pathIndex,x:i.x,y:i.y,wave:i.waveNumber,mods:i.modifiers,reward:0});if(i.special==="split"&&i.splitCount>0){const l=i.splitType||i.type,o=!i.splitType;for(let n=0;n<i.splitCount;n++)s.push({type:l,path:i.path,pathIndex:i.pathIndex,x:i.x,y:i.y,wave:i.waveNumber,mods:i.modifiers,reward:0,hpRatio:i.splitHpRatio,noSplit:o})}if(i.special==="tower_disable"){for(const l of this.towers){const o=l.x-i.x,n=l.y-i.y;Math.sqrt(o*o+n*n)<=i.disableRadius&&(l.disabledTimer=i.disableDuration)}this.particles.emitDeath(i.x,i.y,"#ff0000",i.disableRadius*.3),M.towerDisable()}}this.enemies.splice(t,1)}}for(const t of s){const i=new G(t.type,t.wave,t.mods,t.path);i.pathIndex=t.pathIndex,i.x=t.x+(Math.random()-.5)*14,i.y=t.y+(Math.random()-.5)*14,i.reward=t.reward,t.hpRatio&&(i.maxHp=Math.round(i.maxHp*t.hpRatio),i.hp=i.maxHp,i.radius=Math.round(i.radius*.7)),t.noSplit&&(i.special=null,i.splitCount=0),this.enemies.push(i)}for(const t of this.towers)t.update(e,this.enemies,this.createProjectile.bind(this),this.particles,this.globalMods);for(const t of this.projectiles)t.update(e,this.enemies);this.projectiles=this.projectiles.filter(t=>t.alive),this.ui.updateHUD(),this.ui.updateTowerButtons(),this.autoWave&&this.waveManager.canStartWave&&!this._autoWaveQueued&&(this._autoWaveQueued=!0,setTimeout(()=>{this._destroyed||this.gameOver||(this._autoWaveQueued=!1,this.autoWave&&this.waveManager.canStartWave&&this._autoStartWave())},500))}async _autoStartWave(){if(!this.waveManager.canStartWave||this._destroyed)return;const e=this.waveManager.waveNumber+1;if(e>1&&e%10===1){const i=await this.ui.showGlobalModifierCards();if(this._destroyed)return;i.apply(this.globalMods),this.globalMods.lifeDrain>0&&(this.lives=Math.max(1,this.lives-this.globalMods.lifeDrain),this.globalMods.lifeDrain=0,this.ui.updateHUD())}const s=Y(e),t=this.ui.autoPickModifier(s);t.hpMult*=this.globalMods.hpMult,t.speedMult*=this.globalMods.speedMult,t.countMult*=this.globalMods.countMult,t.rewardMult*=this.globalMods.rewardMult,t.regenPercent+=this.globalMods.regenPercent,t.spawnMult*=this.globalMods.spawnMult,t.sizeMult*=this.globalMods.sizeMult,this.waveManager.startNextWave(t),M.waveStart(),this.ui.updateTowerButtons()}endGame(){this.gameOver=!0,this.hideSellTooltip(),M.gameOver(),document.getElementById("game-over").classList.remove("hidden"),document.getElementById("game-over-wave").textContent=`Вы продержались ${this.waveManager.waveNumber} волн`}loop(e){if(this._destroyed)return;const s=Math.min((e-this.lastTime)/1e3,.05);this.lastTime=e;const t=s*this.gameSpeed;this.update(t),this.renderer.render({towers:this.towers,enemies:this.enemies,projectiles:this.projectiles,placementPreview:this.placementPreview,particles:this.particles,time:this.time,dragState:this.dragState}),this._rafId=requestAnimationFrame(this.loop)}}
